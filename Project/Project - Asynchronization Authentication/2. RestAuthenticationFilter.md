-----
### ìŠ¤í”„ë§ ì‹œíë¦¬í‹° í•„í„° ì„¤ì •
-----
1. ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ëŠ” HttpSecurity ì„¤ì •ì„ í†µí•´ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ë³´ì•ˆ ìš”êµ¬ì‚¬í•­ì— ë§ê²Œ í•„í„° ì²´ì¸ì„ ì¶”ê°€í•  ìˆ˜ ìˆë„ë¡ ì œê³µ
2. í•„í„° ì¶”ê°€ëŠ” addFilterBefore, addFilterAfter, addFilter, addFilterAt ë©”ì„œë“œë¥¼ ì‚¬ìš©í•˜ì—¬ í•„í„°ì˜ ìˆœì„œì™€ ìœ„ì¹˜ë¥¼ ì œì–´í•  ìˆ˜ ìˆìŒ

-----
### ìŠ¤í”„ë§ ì‹œíë¦¬í‹° í•„í„° ì¶”ê°€
-----
1. addFilterBefore : ì§€ì •ëœ í•„í„°ë¥¼ í•„í„° ì²´ì¸ì˜ íŠ¹ì • í•„í„° ì´ì „ì— ì¶”ê°€í•˜ë©° ì£¼ë¡œ íŠ¹ì • ì²˜ë¦¬ê°€ ë‹¤ë¥¸ í•„í„°ë³´ë‹¤ ë¨¼ì € ì‹¤í–‰ë˜ì–´ì•¼í•  ë•Œ ì‚¬ìš©
```java
http.addFilterBefore(new CustomFilter(), UsernamePasswordAuthenticationFilter.class):
```

2. addFilterAfter : ì§€ì •ëœ í•„í„°ë¥¼ í•„í„° ì²´ì¸ì˜ íŠ¹ì • í•„í„° ì´í›„ì— ì¶”ê°€í•˜ì—¬ íŠ¹ì • ì‘ì—…ì´ ë‹¤ë¥¸ í•„í„°ì˜ ì²˜ë¦¬ë¥¼ ë”°ë¼ì•¼ í•  ë•Œ ìœ ìš©
```java
http.addFilterAfter(new CustomFilter(), UsernamePasswordAuthenticationFilter.class):
```

3. ğŸ’¡ addFilter
   - ì‹œíë¦¬í‹° í•„í„° ì²´ì¸ì— ìƒˆë¡œìš´ í•„í„°ë¥¼ ì¶”ê°€í•˜ë©°, í•„í„°ì˜ ìœ„ì¹˜ë¥¼ ì§€ì •í•˜ì§€ ì•Šê³ , í•„í„°ì˜ ìœ í˜•(í´ë˜ìŠ¤ íƒ€ì…)ì— ë”°ë¼ ìë™ìœ¼ë¡œ ì ì ˆí•œ ìœ„ì¹˜ì— í•„í„°ë¥¼ ì¶”ê°€
   - ì¶”ê°€í•˜ëŠ” í•„í„°ê°€ ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ì˜ í•„í„°ë¥¼ ìƒì†ë°›ì„ ê²½ìš°ì— í•´ë‹¹í•˜ë©°, ê·¸ë ‡ì§€ ì•Šì€ ê²½ìš°ì—ëŠ” ì˜ˆì™¸ ë°œìƒ
```java
http.addFilter(new CustomFilter());
```

4. addFilterAt : ì§€ì •ëœ í•„í„°ë¥¼ í•„í„° ì²´ì¸ì˜ íŠ¹ì • ìœ„ì¹˜ì— ì¶”ê°€í•˜ë©° íŠ¹ì • í•„í„°ë¥¼ ëŒ€ì²´í•˜ì§€ ì•ŠìŒ
```java
http.addFilterAt(new CustomFilter(), UsernamePasswordAuthenticationFilter.class); // CustomFilterë¥¼ UsernamePasswordAuthenticationFilterê°€ ìœ„ì¹˜í•œ ê³³ì— ë„£ë˜, UsernamePasswordAuthenticationFilter(ìœ„ì¹˜ëŠ” ë‹¬ë¼ì§)ê°€ ì‚¬ë¼ì§€ëŠ” ê²ƒì´ ì•„ë‹˜ 
```

-----
### í•„í„° ì„¤ì •
-----
<div align="center">
<img src="https://github.com/user-attachments/assets/2950c0ab-39cf-4d53-a811-11648396e28a">
</div>

-----
### í•„í„° êµ¬í˜„
-----
<div align="center">
<img src="https://github.com/user-attachments/assets/f164d763-88b5-4675-8f45-10f3d6659b61">
</div>

1. AbstractAuthenticationProcessingFilterëŠ” UsernamePasswordAuthenticationFilterì˜ ë¶€ëª¨
2. ìƒì„±ìì˜ AntPathReuqestMatcher("/api/login", "POST") : /api/login URLì„ ìš”ì²­í•˜ê³ , POST ë°©ì‹ì´ë©´ í•„í„° ì‹¤í–‰
3. WebUtil.isAjax() : ë¹„ë™ê¸° ìš”ì²­ì¸ì§€ ì•„ë‹Œì§€ í™•ì¸ (ìŠ¤í”„ë§ 3.x ë¯¸ë§Œ ë²„ì „ì—ì„œ ê°€ëŠ¥)

-----
### ì½”ë“œ
-----
1. RestAuthenticationToken
```java
package io.security.springSecurityMaster.security.token;

import org.springframework.security.authentication.AbstractAuthenticationToken;
import org.springframework.security.core.GrantedAuthority;

import java.util.Collection;

public class RestAuthenticationToken extends AbstractAuthenticationToken {

    private final Object principal;
    private final Object credentials;

    // ê¶Œí•œì„ ë°›ëŠ” ìƒì„±ì
    public RestAuthenticationToken(Collection<? extends GrantedAuthority> authorities, Object principal, Object credentials) {
        super(authorities);
        this.principal = principal;
        this.credentials = credentials;
        setAuthenticated(true); // ê¶Œí•œì„ ë°›ì•˜ìœ¼ë¯€ë¡œ ì¸ì¦ ì™„ë£Œ
    }

    // ê¶Œí•œì„ ë°›ì§€ ì•ŠëŠ” ìƒì„±ì
    public RestAuthenticationToken(Object principal, Object credentials) {
        super(null); // authorities : null
        this.principal = principal;
        this.credentials = credentials;
        setAuthenticated(false); // ê¶Œí•œì„ ë°›ì§€ ëª»í–ˆìœ¼ë¯€ë¡œ false
    }


    @Override
    public Object getCredentials() {
        return this.credentials;
    }

    @Override
    public Object getPrincipal() {
        return this.principal;
    }
}
```


2. RestAuthenticationFilter
```java
package io.security.springSecurityMaster.security.filter;

import com.fasterxml.jackson.databind.ObjectMapper;
import io.security.springSecurityMaster.domain.dto.AccountDto;
import io.security.springSecurityMaster.security.token.RestAuthenticationToken;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import org.springframework.http.HttpMethod;
import org.springframework.security.authentication.AuthenticationServiceException;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.AuthenticationException;
import org.springframework.security.web.authentication.AbstractAuthenticationProcessingFilter;
import org.springframework.security.web.util.matcher.AntPathRequestMatcher;
import org.springframework.util.StringUtils;
import org.springframework.web.util.WebUtils;

import java.io.IOException;

public class RestAuthenticationFilter extends AbstractAuthenticationProcessingFilter {

    private ObjectMapper objectMapper = new ObjectMapper();

    public RestAuthenticationFilter() {
        super(new AntPathRequestMatcher("/api/login", "POST"));
    }

    @Override
    public Authentication attemptAuthentication(HttpServletRequest request, HttpServletResponse response) throws AuthenticationException, IOException, ServletException {

        // POST ë°©ì‹ì´ ì•„ë‹ˆê±°ë‚˜ Ajax ë°©ì‹ì´ ì•„ë‹ˆë¼ë©´ ì˜ˆì™¸
        if(!HttpMethod.POST.name().equals(request.getMethod()) || !isAjax(request)) {
            throw new IllegalArgumentException("Authentication method is not supported");
        }

        // Request ì •ë³´ë¥¼ AccountDtoë¡œ Mapping
        AccountDto accountDto = objectMapper.readValue(request.getReader(), AccountDto.class);

        // Username, Password ë‘˜ ì¤‘ í•˜ë‚˜ê°€ ì—†ê±°ë‚˜, ë‘˜ ë‹¤ ì—†ë‹¤ë©´ ì˜ˆì™¸ ë°œìƒ
        if(!StringUtils.hasText(accountDto.getUsername()) || !StringUtils.hasText(accountDto.getPassword())) {
            throw new AuthenticationServiceException("Username or Password is not provided");
        }

        // Rest í† í° ìƒì„±
        RestAuthenticationToken authenticationToken = new RestAuthenticationToken(accountDto.getUsername(), accountDto.getPassword());

        // AuthenticationManagerëŠ” SecurityConfigì— ì „ë‹¬ (ë¶€ëª¨ì˜ getAuthenticationManager()ì—ì„œ ì²˜ë¦¬í•˜ë‚˜, ë¶€ëª¨ì—ëŠ” í˜„ì¬ AuthenticationManagerê°€ ì—†ìœ¼ë¯€ë¡œ, ì´ë¥¼ SecurityConfigì—ì„œ ë°›ì•„ì™€ì•¼ í•¨)
        return getAuthenticationManager().authenticate(authenticationToken);
    }

    /*
     WebUtil.isAjax() ìŠ¤í”„ë§ 3.x ì´í›„ ë²„ì „ì—ì„œ ì‚­ì œë¨ì— ë”°ë¼ isAjax() ë©”ì„œë“œ êµ¬í˜„
       - X-Requested-With í—¤ë”ê°€ "XMLHttpRequest"ë¼ë©´ Ajax ìš”ì²­
    */
    private boolean isAjax(HttpServletRequest request) {
        String ajaxHeader = request.getHeader("X-Requested-With"); // í—¤ë”ì—ì„œ ajax í—¤ë”ì˜ ê°’ ì¶”ì¶œ
        return "XMLHttpRequest".equals(ajaxHeader); // ë¹„êµ
    }
}
```

3. SecurityConfig
```java
package io.security.springSecurityMaster.security.configs;

import io.security.springSecurityMaster.security.filter.RestAuthenticationFilter;
import io.security.springSecurityMaster.security.handler.FormAccessDeniedHandler;
import jakarta.servlet.http.HttpServletRequest;
import lombok.RequiredArgsConstructor;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.core.annotation.Order;
import org.springframework.security.authentication.AuthenticationDetailsSource;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.authentication.AuthenticationProvider;
import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.AuthenticationFailureHandler;
import org.springframework.security.web.authentication.AuthenticationSuccessHandler;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;
import org.springframework.security.web.authentication.WebAuthenticationDetails;

/*
    ë³´ì•ˆ ê´€ë ¨ (ì¸ì¦, ì¸ê°€ ê´€ë ¨) ê¸°ëŠ¥ êµ¬ì„±
 */

@EnableWebSecurity
@Configuration
@RequiredArgsConstructor
public class SecurityConfig {

    private final AuthenticationProvider authenticationProvider;
    private final AuthenticationDetailsSource<HttpServletRequest, WebAuthenticationDetails> authenticationDetailsSource;
    private final AuthenticationSuccessHandler successHandler;
    private final AuthenticationFailureHandler failureHandler;

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http.
                authorizeHttpRequests(auth -> auth
                        .requestMatchers("/css/**", "/images/**", "/js/**", "/favicon.*", "/*/icon-*").permitAll()
                        .requestMatchers("/", "/signup", "/login*").permitAll()
                        .requestMatchers("/user").hasAuthority("ROLE_USER")
                        .requestMatchers("/manager").hasAuthority("ROLE_MANAGER")
                        .requestMatchers("/admin").hasAuthority("ROLE_ADMIN")
                        .anyRequest().authenticated())
                .formLogin(form ->
                            form.loginPage("/login").permitAll()
                                .authenticationDetailsSource(authenticationDetailsSource)
                                    .successHandler(successHandler)
                                    .failureHandler(failureHandler))
                .authenticationProvider(authenticationProvider)
                .exceptionHandling(exception -> exception.accessDeniedHandler(new FormAccessDeniedHandler("/denied")));

        return http.build();
    }

    @Bean
    @Order(1)
    public SecurityFilterChain restSecurityFilterChain(HttpSecurity http) throws Exception {
        AuthenticationManagerBuilder managerBuilder = http.getSharedObject(AuthenticationManagerBuilder.class);
        AuthenticationManager authenticationManager = managerBuilder.build();

        http.
                securityMatcher("/api/**")
                .authorizeHttpRequests(auth -> auth
                        .requestMatchers("/css/**", "/images/**", "/js/**", "/favicon.*", "/*/icon-*").permitAll()
                        .anyRequest().permitAll())
                .csrf(AbstractHttpConfigurer::disable)
                .addFilterBefore(restAuthenticationFilter(authenticationManager), UsernamePasswordAuthenticationFilter.class)
                .authenticationManager(authenticationManager);

        return http.build();
    }

    private RestAuthenticationFilter restAuthenticationFilter(AuthenticationManager authenticationManager) {
        RestAuthenticationFilter restAuthenticationFilter = new RestAuthenticationFilter();

        /*
           í˜„ì¬ ProviderManagerëŠ” FormAuthenticationManager(í¼ ì¸ì¦) : í•˜ì§€ë§Œ, ì´ í´ë˜ìŠ¤ëŠ” ë¹„ë™ê¸° ì¸ì¦ ë¶ˆê°€
           FormAuthenticationProviderì˜ supports ë©”ì„œë“œì—ì„œëŠ” UsernamePasswordAuthenticationToken.classë§Œ í—ˆìš©í•˜ë¯€ë¡œ falseê°€ ë˜ì–´ í˜„ì¬ëŠ” ë¶ˆê°€
         */
        
        restAuthenticationFilter.setAuthenticationManager(authenticationManager);

        return restAuthenticationFilter;
    }
}
```

