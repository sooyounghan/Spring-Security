-----
### í¼ ì¸ì¦
-----
1. HTTP ê¸°ë°˜ì˜ í¼ ë¡œê·¸ì¸ ì¸ì¦ ë©”ì»¤ë‹ˆì¦˜ì„ í™œì„±í•˜ëŠ” APIë¡œì„œ, ì‚¬ìš©ì ì¸ì¦ì„ ìœ„í•œ ì‚¬ìš©ì ì •ì˜ ë¡œê·¸ì¸ í˜ì´ì§€ë¥¼ ì‰½ê²Œ êµ¬í˜„ ê°€ëŠ¥
2. ê¸°ë³¸ì ìœ¼ë¡œ ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ê°€ ì œê³µí•˜ëŠ” ê¸°ë³¸ ë¡œê·¸ì¸ í˜ì´ì§€ë¥¼ ì‚¬ìš©í•˜ë©°, ì‚¬ìš©ì ì´ë¦„ê³¼ ë¹„ë°€ë²ˆí˜¸ í•„ë“œê°€ í¬í•¨ëœ ê°„ë‹¨í•œ ë¡œê·¸ì¸ ì–‘ì‹ ì œê³µ
3. ì‚¬ìš©ìëŠ” ì›¹ í¼ì„ í†µí•´ ìê²© ì¦ëª…(ì‚¬ìš©ì ì´ë¦„ê³¼ ë¹„ë°€ë²ˆí˜¸)ë¥¼ ì œê³µí•˜ê³ , Spring SecurityëŠ” HttpServletRequestì— ì´ ê°’ì„ ì½ì–´ì˜´
4. í¼ ì¸ì¦ íë¦„
<div align="center">
<img src="https://github.com/user-attachments/assets/52527eb4-0b6b-4427-8797-de63444bd50a">
</div>

-----
### formLogin() API
-----
1. FormLoginConfigurer ì„¤ì • í´ë˜ìŠ¤ë¥¼ í†µí•´ ì—¬ëŸ¬ API ì„¤ì • ê°€ëŠ¥
2. ë‚´ë¶€ì ìœ¼ë¡œ UsernamePasswrodAuthenticationFilterê°€ ìƒì„±ë˜ì–´ í¼ ë°©ì‹ì˜ ì¸ì¦ ì²˜ë¦¬ë¥¼ ë‹´ë‹¹í•˜ê²Œ ë¨
```java
HttpSecurity.formLogin(httpSecurityLoginConfigurer ->
    httpSecurityFormLoginConfigurer
        .loginPage("/loginPage") // ì‚¬ìš©ì ì •ì˜ ë¡œê·¸ì¸ í˜ì´ì§€ ì „í™˜ (ê¸°ë³¸ ë¡œê·¸ì¸ í˜ì´ì§€ ë¬´ì‹œ)
        .loginProcessUrl("/logicProc") // ì‚¬ìš©ì ì´ë¦„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ê²€ì¦í•  URL ì§€ì • (Form Action) (ê¸°ë³¸ê°’ : "/login")
        .defaultSuccessUrl("/", [alwaysUse]) // ë¡œê·¸ì¸ ì„±ê³µ ì´í›„ ì´ë™ í˜ì´ì§€ (alwaysUseê°€ trueì´ë©´ ë¬´ì¡°ê±´ ì§€ì •ëœ ìœ„ì¹˜ë¡œ ì´ë™ (ê¸°ë³¸ê°’ : false))
                                             // ê¸°ë³¸ê°’ (false) : ì¸ì¦ ì „ ë³´ì•ˆì´ í•„ìš”í•œ í˜ì´ì§€ë¥¼ ë°©ë¬¸í•˜ë‹¤ê°€ ì¸ì¦ì— ì„±ê³µí•œ ê²½ìš°ë¼ë©´, ì´ì „ ìœ„ì¹˜ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
        .failureUrl("/failed") // ì¸ì¦ì— ì‹¤íŒ¨í•  ê²½ìš° ì‚¬ìš©ìì—‘ ë³´ë‚´ì§ˆ URLì„ ì§€ì • (ê¸°ë³¸ê°’ : /login?error)
        .usernameParameter("username") // ì¸ì¦ì„ ìˆ˜í–‰í•  ë•Œ, ì‚¬ìš©ì ì´ë¦„(ì•„ì´ë””)ë¥¼ ì°¾ê¸° ìœ„í•´ í™•ì¸í•˜ëŠ” HTTP ë§¤ê°œë³€ìˆ˜ ì„¤ì • (ê¸°ë³¸ê°’ : username)
        .passwordParameter("password") // ì¸ì¦ì„ ìˆ˜í–‰í•  ë•Œ, ë¹„ë°€ë²ˆí˜¸ë¥¼ ì°¾ê¸° ìœ„í•´ í™•ì¸í•˜ëŠ” HTTP ë§¤ê°œë³€ìˆ˜ ì„¤ì • (ê¸°ë³¸ê°’ : password)
        .failureHandler(AuthenticationFailHandler) // ì¸ì¦ ì‹¤íŒ¨ ì‹œ ì‚¬ìš©í•  AuthenticationFailureHandler (ê¸°ë³¸ê°’ : SimpleUrlAuthenticationFailureHandlerë¥¼ ì‚¬ìš©í•˜ì—¬ "/login?error"ë¡œ Redirection)
        .successHanlder(AuthenticationSuccessHandler) // ì¸ì¦ ì„±ê³µ ì‹œ ì‚¬ìš©í•  AuthenticationSuccessHandler (ê¸°ë³¸ê°’ : SavedRequestAwareAuthenticationSuccessHandler)
        .permitAll() // failureUrl(), loginPage(), loginProcessingUrl()ì— ëŒ€í•œ ëª¨ë“  URLì— ëª¨ë“  ì‚¬ìš©ì ì ‘ê·¼ í—ˆìš© (ì¸ì¦ì„ ë°›ì§€ ëª»í•œ ì‚¬ìš©ìë¼ë„ ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •)
);
```

3. ğŸ’¡ ìš°ì„ ìˆœìœ„ : failureHandler / successHandlerê°€ ê°€ì¥ ë†’ìŒ (í•´ë‹¹ ì˜µì…˜ì´ ìˆ˜í–‰ë˜ë©´, defaultSuccessUrlì˜ ì¡°ê±´ì€ ìš°ì„ ìˆœìœ„ì— ë”°ë¼ ë°€ë¦¼)
-----
### ì˜ˆì œ ì½”ë“œ
-----
1. SecurityFilterChain
```java
package io.security.springsecuritymaster;

import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.Customizer;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.AuthenticationException;
import org.springframework.security.core.userdetails.User;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.provisioning.InMemoryUserDetailsManager;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.AuthenticationFailureHandler;
import org.springframework.security.web.authentication.AuthenticationSuccessHandler;

import java.io.IOException;

@EnableWebSecurity
@Configuration
public class SecurityConfig {

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
                .authorizeHttpRequests(auth -> auth.anyRequest().authenticated()) // ì–´ë– í•œ Requestì— ëŒ€í•´ì„œ ì¸ì¦ì„ ë°›ì•„ ì¸ê°€ ì‹¤ì‹œ
                // formLogin(Customzier.customize(T t) : Customí•˜ì—¬ form ë¡œê·¸ì¸ êµ¬ì„± ì‹œ ì‚¬ìš© / .withDefaults() : ê¸°ë³¸ê°’ìœ¼ë¡œ ì‚¬ìš©)
                .formLogin(form ->
                        form
                                .loginPage("/loginPage")
                                .loginProcessingUrl("/loginProc")
                                .defaultSuccessUrl("/", true)
                                .failureUrl("/failed")
                                .usernameParameter("userId")
                                .passwordParameter("passwd")
                                // ìµëª…í´ë˜ìŠ¤ -> ëŒë‹¤ë¡œ ì‚¬ìš© (ë§¤ê°œë³€ìˆ˜ : ìš”ì²­ / ì‘ë‹µ / ì¸ì¦) / defaultSuccessUrlë³´ë‹¤ ìš°ì„ ìˆœìœ„ê°€ ë†’ìŒ
                                .successHandler((request, response, authentication) -> {
                                    System.out.println("authentication = " + authentication);
                                    response.sendRedirect("/home");
                                })
                                // ìµëª…í´ë˜ìŠ¤ -> ëŒë‹¤ë¡œ ì‚¬ìš© (ë§¤ê°œë³€ìˆ˜ : ìš”ì²­ / ì‘ë‹µ / ì¸ì¦ ì‹¤íŒ¨í•œ ì˜ˆì™¸) / defaultSuccessUrlë³´ë‹¤ ìš°ì„ ìˆœìœ„ê°€ ë†’ìŒ
                                .failureHandler((request, response, exception) -> {
                                    System.out.println("exception = " + exception.getMessage());
                                    response.sendRedirect("/login");
                                })
                                .permitAll()
                );
        return http.build();
    }
    ...
}
```
  - ë¡œê·¸ì¸ ì„±ê³µ
```
authentication = UsernamePasswordAuthenticationToken [Principal=org.springframework.security.core.userdetails.User [Username=user, Password=[PROTECTED], Enabled=true, AccountNonExpired=true, CredentialsNonExpired=true, AccountNonLocked=true, Granted Authorities=[ROLE_USER]], Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=0:0:0:0:0:0:0:1, SessionId=60256F88AC3CF885A379CC4A0A21A4CD], Granted Authorities=[ROLE_USER]]
```
  - ë¡œê·¸ì¸ ì‹¤íŒ¨
```
exception = ìê²© ì¦ëª…ì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.
```
2. IndexController
```java
package io.security.springsecuritymaster;

import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class IndexController {

    @GetMapping("/") // ë£¨íŠ¸ í˜ì´ì§€
    public String index() {
        return "index";
    }

    @GetMapping("/loginPage") // ë¡œê·¸ì¸ í˜ì´ì§€
    public String loginPage() {
        return "loginPage";
    }

    @GetMapping("/home") // ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ì§„ì…
    public String home() {
        return "home";
    }
}
```

3. ì‹¤í–‰ ê³¼ì •
   - HttpSecurity
```java
public FormLoginConfigurer<HttpSecurity> formLogin() throws Exception {
    return (FormLoginConfigurer)this.getOrApply(new FormLoginConfigurer());
}
```

   - FormLoginConfigurer
```java
package org.springframework.security.config.annotation.web.configurers;

import org.springframework.security.config.annotation.web.HttpSecurityBuilder;
import org.springframework.security.web.authentication.ForwardAuthenticationFailureHandler;
import org.springframework.security.web.authentication.ForwardAuthenticationSuccessHandler;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;
import org.springframework.security.web.authentication.ui.DefaultLoginPageGeneratingFilter;
import org.springframework.security.web.util.matcher.AntPathRequestMatcher;
import org.springframework.security.web.util.matcher.RequestMatcher;

public final class FormLoginConfigurer<H extends HttpSecurityBuilder<H>> extends AbstractAuthenticationFilterConfigurer<H, FormLoginConfigurer<H>, UsernamePasswordAuthenticationFilter> {
    public FormLoginConfigurer() {
        super(new UsernamePasswordAuthenticationFilter(), (String)null); // ì¸ì¦ì„ ì²˜ë¦¬í•  í•„í„° : UsernamePasswordAuthenticationFilter
        this.usernameParameter("username"); // ê¸°ë³¸ê°’
        this.passwordParameter("password"); // ê¸°ë³¸ê°’
    }

    public FormLoginConfigurer<H> loginPage(String loginPage) {
        return (FormLoginConfigurer)super.loginPage(loginPage);
    }

    public FormLoginConfigurer<H> usernameParameter(String usernameParameter) {
        ((UsernamePasswordAuthenticationFilter)this.getAuthenticationFilter()).setUsernameParameter(usernameParameter);
        return this;
    }

    public FormLoginConfigurer<H> passwordParameter(String passwordParameter) {
        ((UsernamePasswordAuthenticationFilter)this.getAuthenticationFilter()).setPasswordParameter(passwordParameter);
        return this;
    }

    public FormLoginConfigurer<H> failureForwardUrl(String forwardUrl) {
        this.failureHandler(new ForwardAuthenticationFailureHandler(forwardUrl));
        return this;
    }

    public FormLoginConfigurer<H> successForwardUrl(String forwardUrl) {
        this.successHandler(new ForwardAuthenticationSuccessHandler(forwardUrl));
        return this;
    }

    public void init(H http) throws Exception {
        super.init(http);
        this.initDefaultLoginFilter(http);
    }

    protected RequestMatcher createLoginProcessingUrlMatcher(String loginProcessingUrl) {
        return new AntPathRequestMatcher(loginProcessingUrl, "POST");
    }

    private String getUsernameParameter() {
        return ((UsernamePasswordAuthenticationFilter)this.getAuthenticationFilter()).getUsernameParameter();
    }

    private String getPasswordParameter() {
        return ((UsernamePasswordAuthenticationFilter)this.getAuthenticationFilter()).getPasswordParameter();
    }

    private void initDefaultLoginFilter(H http) {
        DefaultLoginPageGeneratingFilter loginPageGeneratingFilter = (DefaultLoginPageGeneratingFilter)http.getSharedObject(DefaultLoginPageGeneratingFilter.class);
        if (loginPageGeneratingFilter != null && !this.isCustomLoginPage()) {
            loginPageGeneratingFilter.setFormLoginEnabled(true);
            loginPageGeneratingFilter.setUsernameParameter(this.getUsernameParameter());
            loginPageGeneratingFilter.setPasswordParameter(this.getPasswordParameter());
            loginPageGeneratingFilter.setLoginPageUrl(this.getLoginPage());
            loginPageGeneratingFilter.setFailureUrl(this.getFailureUrl());
            loginPageGeneratingFilter.setAuthenticationUrl(this.getLoginProcessingUrl());
        }

    }
}
```

   - AbstractAuthenticationFilterConfigurer : FormLoginConfigurerì˜ ë¶€ëª¨ í´ë˜ìŠ¤
```java
import jakarta.servlet.http.HttpServletRequest;
import java.util.Arrays;
import java.util.Collections;
import org.springframework.http.MediaType;
import org.springframework.security.authentication.AuthenticationDetailsSource;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.config.annotation.web.HttpSecurityBuilder;
import org.springframework.security.web.AuthenticationEntryPoint;
import org.springframework.security.web.PortMapper;
import org.springframework.security.web.authentication.AbstractAuthenticationProcessingFilter;
import org.springframework.security.web.authentication.AuthenticationFailureHandler;
import org.springframework.security.web.authentication.AuthenticationSuccessHandler;
import org.springframework.security.web.authentication.LoginUrlAuthenticationEntryPoint;
import org.springframework.security.web.authentication.RememberMeServices;
import org.springframework.security.web.authentication.SavedRequestAwareAuthenticationSuccessHandler;
import org.springframework.security.web.authentication.SimpleUrlAuthenticationFailureHandler;
import org.springframework.security.web.authentication.session.SessionAuthenticationStrategy;
import org.springframework.security.web.context.SecurityContextRepository;
import org.springframework.security.web.savedrequest.RequestCache;
import org.springframework.security.web.util.matcher.AndRequestMatcher;
import org.springframework.security.web.util.matcher.MediaTypeRequestMatcher;
import org.springframework.security.web.util.matcher.NegatedRequestMatcher;
import org.springframework.security.web.util.matcher.RequestHeaderRequestMatcher;
import org.springframework.security.web.util.matcher.RequestMatcher;
import org.springframework.web.accept.ContentNegotiationStrategy;
import org.springframework.web.accept.HeaderContentNegotiationStrategy;

public abstract class AbstractAuthenticationFilterConfigurer<B extends HttpSecurityBuilder<B>, T extends AbstractAuthenticationFilterConfigurer<B, T, F>, F extends AbstractAuthenticationProcessingFilter> extends AbstractHttpConfigurer<T, B> {
    private F authFilter;
    private AuthenticationDetailsSource<HttpServletRequest, ?> authenticationDetailsSource;
    private SavedRequestAwareAuthenticationSuccessHandler defaultSuccessHandler;
    private AuthenticationSuccessHandler successHandler;
    private LoginUrlAuthenticationEntryPoint authenticationEntryPoint;
    private boolean customLoginPage;
    private String loginPage;
    private String loginProcessingUrl;
    private AuthenticationFailureHandler failureHandler;
    private boolean permitAll;
    private String failureUrl;

    ...

    protected AbstractAuthenticationFilterConfigurer() {
        this.defaultSuccessHandler = new SavedRequestAwareAuthenticationSuccessHandler();
        this.successHandler = this.defaultSuccessHandler;
        this.setLoginPage("/login"); // ê¸°ë³¸ ë¡œê·¸ì¸ í˜ì´ì§€
    }

    ...

    public void init(B http) throws Exception { // ì´ˆê¸°í™”
        this.updateAuthenticationDefaults(); // ê¸°ë³¸ì  ì¸ì¦ ì„¸íŒ… ì„¤ì •
        this.updateAccessDefaults(http); // permitAll()
        this.registerDefaultAuthenticationEntryPoint(http);
    }

    ...

    public void configure(B http) throws Exception {
        PortMapper portMapper = (PortMapper)http.getSharedObject(PortMapper.class);
        if (portMapper != null) {
            this.authenticationEntryPoint.setPortMapper(portMapper);
        }

        RequestCache requestCache = (RequestCache)http.getSharedObject(RequestCache.class);
        if (requestCache != null) {
            this.defaultSuccessHandler.setRequestCache(requestCache);
        }

        this.authFilter.setAuthenticationManager((AuthenticationManager)http.getSharedObject(AuthenticationManager.class));
        this.authFilter.setAuthenticationSuccessHandler(this.successHandler);
        this.authFilter.setAuthenticationFailureHandler(this.failureHandler);
        if (this.authenticationDetailsSource != null) {
            this.authFilter.setAuthenticationDetailsSource(this.authenticationDetailsSource);
        }

        SessionAuthenticationStrategy sessionAuthenticationStrategy = (SessionAuthenticationStrategy)http.getSharedObject(SessionAuthenticationStrategy.class);
        if (sessionAuthenticationStrategy != null) {
            this.authFilter.setSessionAuthenticationStrategy(sessionAuthenticationStrategy);
        }

        RememberMeServices rememberMeServices = (RememberMeServices)http.getSharedObject(RememberMeServices.class);
        if (rememberMeServices != null) {
            this.authFilter.setRememberMeServices(rememberMeServices);
        }

        SecurityContextConfigurer securityContextConfigurer = (SecurityContextConfigurer)http.getConfigurer(SecurityContextConfigurer.class);
        if (securityContextConfigurer != null && securityContextConfigurer.isRequireExplicitSave()) {
            SecurityContextRepository securityContextRepository = securityContextConfigurer.getSecurityContextRepository();
            this.authFilter.setSecurityContextRepository(securityContextRepository);
        }

        this.authFilter.setSecurityContextHolderStrategy(this.getSecurityContextHolderStrategy());
        F filter = (AbstractAuthenticationProcessingFilter)this.postProcess(this.authFilter);
        http.addFilter(filter); // ì¸ì¦ í•„í„° ì¶”ê°€
    }
```
