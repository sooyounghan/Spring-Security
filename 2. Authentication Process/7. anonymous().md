-----
### ìµëª… ì‚¬ìš©ì
-----
1. ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ì—ì„œ 'ìµëª…ìœ¼ë¡œ ì¸ì¦ëœ' ì‚¬ìš©ìì™€ ì¸ì¦ë˜ì§€ ì•Šì€ ì‚¬ìš©ì ê°„ì— ì‹¤ì œ ê°œë…ì  ì°¨ì´ëŠ” ì—†ìœ¼ë©°, ë‹¨ì§€ ì•¡ì„¸ìŠ¤ ì œì–´ ì†ì„±ì„ êµ¬ì„±í•˜ëŠ” ë” í¸ë¦¬í•œ ë°©ë²• ì œê³µí•œë‹¤ê³  ë³¼ ìˆ˜ ìˆìŒ
2. SecurityContextHolderê°€ í•­ìƒ Authentication ê°ì²´ë¥¼ í¬í•¨í•˜ê³  NULLì„ í¬í•¨í•˜ì§€ ì•ŠëŠ”ë‹¤ëŠ” ê²ƒì„ ê·œì¹™ìœ¼ë¡œ ì„¸ìš°ê²Œ ë˜ë©´ í´ë˜ìŠ¤ë¥¼ ë” ê²¬ê³ í•˜ê²Œ ì‘ì„± ê°€ëŠ¥
3. ğŸ’¡ ì¸ì¦ ì‚¬ìš©ìì™€ ìµëª… ì¸ì¦ ì‚¬ìš©ìë¥¼ êµ¬ë¶„í•´ì„œ ì–´ë–¤ ê¸°ëŠ¥ì„ ìˆ˜í–‰í•˜ê³ ì í•  ë•Œ ìœ ìš©í•  ìˆ˜ ìˆìœ¼ë©°, ìµëª… ì¸ì¦ ê°ì²´ë¥¼ ì„¸ì…˜ì— ì €ì¥í•˜ì§€ ì•ŠìŒ
4. ìµëª… ì¸ì¦ ì‚¬ìš©ì ê¶Œí•œì„ ë³„ë„ë¡œ ìš´ìš© ê°€ëŠ¥ (ì¦‰, ì¸ì¦ëœ ì‚¬ìš©ìê°€ ì ‘ê·¼í•  ìˆ˜ ì—†ë„ë¡ êµ¬ì„± ê°€ëŠ¥)

-----
### ìµëª… ì‚¬ìš©ì API ë° êµ¬ì¡°
-----
```java
@Bean
public SecurityChainFilter securityChainFilter(HttpSecurity http) throws Excepion {
    http
      .authorizedHttpRequests(auth -> auth.anyRequest().authenticated())
      .formLogin(Customizer.withDefaults())
      .anonymous(anonymous -> anonymous
          .principal("guest")
          .autorities("ROLE_GUEST)
    );
    return http.build();
}
```

<div align="center">
<img src="https://github.com/user-attachments/assets/6ec4550b-04a3-4aea-acf4-ea227555456c">
</div>

-----
### ìŠ¤í”„ë§ MVCì—ì„œ ìµëª… ì¸ì¦ ì‚¬ìš©í•˜ê¸°
-----
1. ìŠ¤í”„ë§ MVCê°€ HttpServletRequest#getPrincipalì„ ì‚¬ìš©í•´ì„œ íŒŒë¼ë¯¸í„°ë¥¼ í•´ê²°í•˜ëŠ”ë°, ìš”ì²­ì´ ìµëª…ì¼ ë•Œ ì´ ê°’ì€ null
```java
public String method(Authentication authentication) { // HttpServletRequest#getPrincipalê°€ Authentication ê°ì²´ ë‚´ë¶€ì—ì„œ ë™ì‘
    if(authentication instanceof AnonymousAuthenticationToken) {
      return "anonymous";
    } else {
      return "not anonymous";
    }
}
```

2. ìµëª… ìš”ì²­ì—ì„œ Authenticationì„ ì–»ê³  ì‹¶ë‹¤ë©´, @CurrentSecurityContext(í˜„ì¬ SecurityContextë¥¼ ì–»ì–´ì˜´)ë¥¼ ì‚¬ìš©
3. CuurentSecurityArgumentResolverì—ì„œ ìš”ì²­ì„ ê°€ë¡œì±„ì–´ ì²˜ë¦¬
```java
public String method(@CurrentSecurityContext SecurityContext context) {
    return context.getAuthentication().getName(); // í˜„ì¬ SecurityContextë¥¼ í†µí•´ ê°ì²´ ì •ë³´ë¥¼ ì–»ì–´ì™€ ìµëª… ì¸ì¦ëœ ì‚¬ìš©ì ë°›ì•„ì˜¤ê¸°
}
```

-----
### AnonymousAuthenticationFilter
-----
: SecurityContextHolderì—ì„œ Authentication ê°ì²´ê°€ ì—†ì„ ê²½ìš° ê°ì§€í•˜ê³ , í•„ìš”í•œ ê²½ìš° ìƒˆë¡œìš´ Authentication ê°ì²´ë¡œ ì±„ì›€
<div align="center">
<img src="https://github.com/user-attachments/assets/c7763f16-b84d-49e8-9626-392b417b53d1">
</div>

-----
### ì½”ë“œ
-----
1. SecurityConfig
```java
    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
                .authorizeHttpRequests(auth -> auth
                        .requestMatchers("/anonymous").hasRole("GUEST") // GUEST ê¶Œí•œ, ì¦‰ ìµëª… ì‚¬ìš©ìë§Œì´ /anonymousì— ì ‘ê·¼ì´ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •  
                        .requestMatchers("/anonymousContext", "/authentication").permitAll() // ë‘ ìì›ì— ëŒ€í•´ì„œëŠ” ìµëª… ì‚¬ìš©ìë¥¼ ì°¸ì¡°í•˜ë„ë¡ ì„¤ì •
                        .anyRequest().authenticated()) // ì–´ë– í•œ Requestì— ëŒ€í•´ì„œ ì¸ì¦ì„ ë°›ì•„ ì¸ê°€ ì‹¤ì‹œ
                .formLogin(Customizer.withDefaults())
                .anonymous(anonymous -> anonymous
                        .principal("guest")
                        .authorities("ROLE_GUEST")
                );  

        return http.build();
    }
```

2. IndexController
```java
package io.security.springsecuritymaster;

import org.springframework.security.authentication.AnonymousAuthenticationToken;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.annotation.CurrentSecurityContext;
import org.springframework.security.core.context.SecurityContext;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class IndexController {

    @GetMapping("/")
    public String index() {
        return "index";
    }

    @GetMapping("/loginPage")
    public String loginPage() {
        return "loginPage";
    }

    @GetMapping("/home")
    public String home() {
        return "home";
    }

    @GetMapping("/anonymous")
    public String anonymous() {
        return "anonymous"; // ê¶Œí•œì„ ê°€ì§„ í›„ ì ‘ê·¼í•˜ë ¤í•˜ë©´, ì ‘ê·¼ ë¶ˆê°€ (ì´ë¯¸ ì¸ì¦ì„ ë°›ì•˜ìœ¼ë¯€ë¡œ) (ì¦‰, GUEST ê¶Œí•œì´ ì—†ìŒ)
    }

    @GetMapping("/authentication") 
    public String authentication(Authentication authentication) { // Authentication ê°ì²´ë¥¼ íŒŒë¼ë¯¸í„°ë¡œ ë°›ìŒ (ìµëª… ê°ì²´ë¥¼ ì°¸ì¡°ë°›ì§€ ëª»í•˜ê³  ìˆìŒ)
        if(authentication instanceof AnonymousAuthenticationToken) { // ìµëª… ì‚¬ìš©ì ê°ì²´ë¼ë©´,
            return "anonymous"; 
        } else { // ì•„ë‹ˆë¼ë©´, Nullì´ë¯€ë¡œ ìµëª… ê°ì²´ ì°¸ì¡° ë¶ˆê°€
            return "not anonymous";
        }
    }

    @GetMapping("/anonymousContext") // ìµëª… ê°ì²´ ì°¸ì¡°
    public String anonymousContext(@CurrentSecurityContext SecurityContext securityContext) {
        return securityContext.getAuthentication().getName(); // í˜„ì¬ SecurityContextì—ì„œ ìµëª… ê°ì²´ë¥¼ ì°¸ì¡° ë°›ì•„ ì‚¬ìš©
    }
}
```

3. CurrentSecurityContextArgumentResolver
```java
public Object resolveArgument(MethodParameter parameter, ModelAndViewContainer mavContainer, NativeWebRequest webRequest, WebDataBinderFactory binderFactory) {
    SecurityContext securityContext = this.securityContextHolderStrategy.getContext(); // ì‚¬ìš©ìì˜ ì¸ì¦ ê°ì²´ë¥¼ ì°¸ì¡°í•  ìˆ˜ ìˆë„ë¡ í•˜ëŠ” API
    if (securityContext == null) {
        return null;
    } else {
        CurrentSecurityContext annotation = this.findMethodAnnotation(parameter);
        return annotation != null ? this.resolveSecurityContextFromAnnotation(parameter, annotation, securityContext) : securityContext;
    }
}

private Object resolveSecurityContextFromAnnotation(MethodParameter parameter, CurrentSecurityContext annotation, SecurityContext securityContext) {
    Object securityContextResult = securityContext;
    String expressionToParse = annotation.expression();
    if (StringUtils.hasLength(expressionToParse)) {
        StandardEvaluationContext context = new StandardEvaluationContext();
        context.setRootObject(securityContext);
        context.setVariable("this", securityContext);
        context.setBeanResolver(this.beanResolver);
        Expression expression = this.parser.parseExpression(expressionToParse);
        securityContextResult = expression.getValue(context);
    }

    if (securityContextResult != null && !parameter.getParameterType().isAssignableFrom(securityContextResult.getClass())) {
        if (annotation.errorOnInvalidType()) {
            throw new ClassCastException("" + securityContextResult + " is not assignable to " + parameter.getParameterType());
        } else {
            return null;
        }
    } else {
        return securityContextResult;
    }
}
```

