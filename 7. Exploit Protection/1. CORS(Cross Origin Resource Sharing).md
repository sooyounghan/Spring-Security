-----
### CORS(Cross Origin Resource Sharing, 교차 출처 리소스 공유)
-----
1. 웹에서는 보안을 위해 기본적으로 한 웹 페이지(출처 A)에서 다른 웹 페이지(출처 B)의 데이터를 불러오는 것을 제한하는데 이를 '동일 출처 정책(Same-Origin Policy)'
2. 만약, 다른 출처의 리소스를 안전하게 사용하고자 할 경우, CORS가 등장하며, CORS는 특별한 HTTP 헤더를 통해 한 웹 페이지가 다른 출처의 리소스에 접근할 수 있도록 '허가'를 구하는 방법
3. 즉, 웹 어플리케이션이 다른 출처의 데이터를 사용하고자 할 때, 브라우저가 그 요청을 대신해서 해당 데이터를 사용해도 되는지 다른 출처에게 물어보는 것
4. 출처를 비교하는 로직은 서버에 구현된 스펙이 아닌 브라우저에 구현된 스펙 기준으로 처리되며, 브라우저는 클라이언트의 요청 헤더와 서버의 응답 헤더를 비교해서 최종 응답을 결정
5. 💡 두 개의 출처를 비교하는 방법은 URL 구성 요소 중 Protocol, Host, Port이 세 가지가 동일한지 확인하면 되고, 나머지가 틀려도 상관 없음
<div align="Center">
<img src="https://github.com/user-attachments/assets/efd45a34-ac16-4e18-8304-92c315ff38fd">
</div>

-----
### CORS 종류
-----
1. Simple Request
   - 예비 요청(Preflight) 과정 없이 자동으로 CORS가 작동하여 서버에 본 요청을 한 후, 서버가 응답의 헤더에 Access-Controll-Allow-Origin과 같은 값을 전송
   - 브라우저가 서로 비교 후, CORS 정책 위반 여부를 검사하는 방식
   - 제약 사항
     + GET, POST, HEAD 중의 한가지 Method를 사용
     + 헤더는 Accept, Accept-Language, Content-Language, Content-Type, DPR, Downlink, Save-Data, Viewport-Width Width만 가능하고, Custom Header는 허용되지 않음
     + Content-Type은 application/x-www-form-urlencoded, multipart/form-data, text/plain만 가능
<div align="Center">
<img src="https://github.com/user-attachments/assets/7cca6528-4bef-4c66-a7ed-8b5623dac06a">
</div>

2. Preflight Request (예비 요청)
   - 브라우저는 요청을 한 번에 보내지 않고, 예비 요청과 본 요청을 나누어 서버에 전달
   - 브라우저가 예비 요청을 보내는 것을 Preflight
   - 이 예비 요청 메서드에는 OPTIONS가 사용 (요청에 대해 지원하는 HTTP 메서드를 미리 탐색하고자 할 때 사용)
   - 💡 예비 요청의 역할을 본 요청을 보내기 전 브라우저가 스스로 안전한 요청인지 확인하는 것으로 요청 사양이 Simple Request에 해당하지 않을 경우 브라우저가 Preflight Request를 실행
<div align="Center">
<img src="https://github.com/user-attachments/assets/de188357-19c9-4927-8a3d-415d32149b93">
</div>

-----
### Preflight Request (예비 요청)
-----
1. A Service
<div align="Center">
<img src="https://github.com/user-attachments/assets/9fa03abf-537e-4d8b-b2b0-99037589b5eb">
</div>

  - 브라우저가 보낸 요청을 보면 Origin에 대한 정보 뿐만 아니라, 예비 요청 이후에 전송할 본 요청에 대한 다른 정보들도 함께 포함되어 있음을 알 수 있음
  - 이 예비 요청에서 Access-Contorl-Request-Headers를 사용하여 자신이 본 요청에서 Content-Type 헤더를 사용할 것을 알려주거나, Access-Control-Request-Method를 사용하여 GET 메서드를 사용할 것을 서버에게 미리 알려줌

2. B Service (Server)
<div align="Center">
<img src="https://github.com/user-attachments/assets/7a4e5d2c-7b9b-4953-a1db-375f22b65c71">
</div>

  - 서버가 보내준 응답 헤더에 포함된 ```Access-Contorl-Allow-Origin: https://security.io```의 의미는 해당 URL 외에 다른 출처로 요청할 경우에는 CORS 정책을 위반했다고 판단하고 오류 메세지를 내고 응답을 버리게 됨

-----
### 동일 출처 기준
-----
<div align="Center">
<img src="https://github.com/user-attachments/assets/9b6f2cd9-93f3-4403-b011-deb0be250414">
</div>

-----
### CORS 해결 : 서버에서 Access-Contorl-Allow-* 세팅
-----
1. Access-Control-Allow-Origin : 헤더에 작성된 출처만 브라우저가 리소스에 접근할 수 있도록 허용
   - ```*```, ```https://security.io```
  
2. Access-Control-Allow-Methods : Preflight Request에 대한 응답으로 실제 요청 중에 사용할 수 있는 메서드를 나타냄
   - 기본값 : GET, POST, HEAD, OPTIONS, ```*```
  
3. Access-Control-Allow-Headers : Preflight Request에 대한 응답으로 실제 요청 중에 사용할 수 있는 헤더 필드 이름을 나타냄
   - 기본값 : Origin, Accept, X-Requested-With, Content-Type, Access-Control-Request-Method, Access-Control-Requst-Headers, Custom Header, ```*```
  
4. Access-Control-Allow-Credentials : 실제 요청에 쿠키나 인증 등의 사용자 자격 증명이 포함될 수 있음을 나타냄 (Client의 credentials:include 옵션일 경우 true 필수)
5. Access-Control-Max-Age : Preflight 요청 결과를 캐시할 수 있는 시간을 나타내는 것으로 해당 시간 동안은 Prefilght 요청을 다시 하지 않게 됨

-----
### cors() & CorsFilter
-----
1. CORS의 사전 요청(Pre-flight Request)에는 쿠키(JSESSIONID)가 포함되어 있지 않기 때문에, Spring Security 이전에 처리되어야 함
2. 사전 요청에 쿠키가 없고, Spring Security가 먼저 처리되면, 요청은 사용자가 인증되지 않았다고 판단하고 거부할 수 있음
3. CORS가 먼저 처리되도록 하기 위해서는 CorsFilter를 사용할 수 있으며, CorsFilter에 CorsConfigurationSource를 제공함으로써 Spring Security와 통합 할 수 있음
```java
@Bean
SecurityFilterChain defaultSecurityFilterChain(HttpSecurity http) throws Exception {
    http.cors(cors -> cors.configurationSource(corsConfigurationSource())); // 커스텀하게 사용할 CorsConfigurationSource를 설정
                                                                            // CorsConfigurationSource를 설정하지 않으면 Spring MVC의 CORS 구성을 사용
    return http.build();
}

@Bean
public CorsConfigurationSource corsConfigurationSource() {
    CorsConfiguration configuration = new CorsConfiguration();
    configuration.addAllowedOrigin("https://example.com");
    configuration.addAllowedMethod("GET", "POST");
    configuration.setAllowCredentials(true);
    UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
    source.registerCorsConfiguration("/**", configuration);
    return source;
}
```

-----
### 코드
-----
1. Moudel - Cors1 (Client) (Port : 8081)
   - Index.html
```html
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script>

        function corsTest(){
            fetch("http://localhost:8082/api/users",{
                method : "GET",
                headers : {
                    "Content-Type" : "text/xml",
                }
            })
                .then(response => {
                    response.json().then(function(data){
                        console.log(data)
                    })
                })
        }

    </script>
</head>
<body>
<button name="corsTest" onclick="corsTest()">corsTest</button>
</body>
</html>
```

   - IndexController
```java
package io.security.cors1;

import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;

@Controller
public class IndexController {
    
    @GetMapping
    public String index() {
        return "index";
    }
}
```

2. Module2 - Cors2 (Server) (Port : 8082)
   - SecurityConfig
```java
package io.security.cors2;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.core.userdetails.User;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.provisioning.InMemoryUserDetailsManager;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.CorsConfigurationSource;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;

@EnableWebSecurity
    @Configuration
    public class SecurityConfig {

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {

        http
                .authorizeHttpRequests(auth -> auth
                        .anyRequest().permitAll())
                .cors(cors -> cors.configurationSource(corsConfigurationSource()));

        return http.build();
    }

    @Bean
    public CorsConfigurationSource corsConfigurationSource() {
        CorsConfiguration configuration = new CorsConfiguration();

        configuration.addAllowedOrigin("http://localhost:8081"); // 출처 설정
        configuration.addAllowedMethod("*"); // 모든 메서드 설정
        configuration.addAllowedHeader("*"); // 모든 헤더 설정
        configuration.setAllowCredentials(true); // 모든 정보(쿠키, 세션 등) 설정
        configuration.setMaxAge(3600L); // 3600ms

        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration("/**", configuration); // 모든 경로에 대해 지정

        return source;
    }

    @Bean
    public UserDetailsService userDetailsService() {
        UserDetails user = User.withUsername("user")
                .password("{noop}1111")
                .roles("USER")
                .build();

        return new InMemoryUserDetailsManager(user);
    }
}
```

   - IndexController
```java
package io.security.cors2;

import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping("/api")
public class IndexController {
    
    @GetMapping("/users")
    public String users() {
        return "{\"name\": \"hong gil dong\"}";
    }
}
```

3. Preflight
<div align="center">
<img src="https://github.com/user-attachments/assets/be84c8b5-fc3f-4833-855e-ef0d47b6cf82">
</div>

4. 본 요청
<div align="center">
<img src="https://github.com/user-attachments/assets/62bafea1-8f31-44dc-9af3-351b5983ef03">
</div>

5. Simple Request 예제
   - index.html
```html
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script>

        function corsTest(){
            fetch("http://localhost:8082/api/users",{
                method : "GET",
                /* headers :  {
                    "Content-Type" : "text/xml",
                } */ // Simple Request 조건 충족
            })
                .then(response => {
                    response.json().then(function(data){
                        console.log(data)
                    })
                })
        }

    </script>
</head>
<body>
<button name="corsTest" onclick="corsTest()">corsTest</button>
</body>
</html>
```

   - 본 요청만 전송
<div align="center">
<img src="https://github.com/user-attachments/assets/b185ef7b-17e4-4e96-aff1-e387108bcfbf">
</div>
