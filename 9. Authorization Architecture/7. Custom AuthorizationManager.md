-----
### ê°œìš”
-----
: ì‚¬ìš©ì ì •ì˜ AuthorizationManagerë¥¼ ìƒì„±í•¨ìœ¼ë¡œ ë©”ì„œë“œ ë³´ì•ˆì„ êµ¬í˜„ ê°€ëŠ¥

-----
### ì„¤ì • í´ë˜ìŠ¤ ì •ì˜
-----
: MethodSecurityConfig
```java
package io.security.springsecuritymaster.method;

import org.springframework.aop.Advisor;
import org.springframework.beans.factory.config.BeanDefinition;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Role;
import org.springframework.security.authorization.method.AuthorizationManagerAfterMethodInterceptor;
import org.springframework.security.authorization.method.AuthorizationManagerBeforeMethodInterceptor;
import org.springframework.security.config.annotation.method.configuration.EnableMethodSecurity;

@EnableMethodSecurity(prePostEnabled = false) // ì‹œíë¦¬í‹°ê°€ ì œê³µí•˜ëŠ” í´ë˜ìŠ¤ë“¤ì„ ë¹„í™œì„±í™”, ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ì¤‘ë³µí•´ì„œ ê²€ì‚¬
@Configuration
public class MethodSecurityConfig {

    @Bean
    @Role(BeanDefinition.ROLE_INFRASTRUCTURE)
    public Advisor preAuthorize() {
        return AuthorizationManagerBeforeMethodInterceptor.preAuthorize(new MyPreAuthorizationManager());
    }

    @Bean
    @Role(BeanDefinition.ROLE_INFRASTRUCTURE)
    public Advisor postAuthorize() {
        return AuthorizationManagerAfterMethodInterceptor.postAuthorize(new MyPostAuthorizationManager());
    }
}
```

-----
### ì‚¬ìš©ì ì •ì˜ AuthorizationManager êµ¬í˜„
-----
1. MyPreAuthorizationManager
```java
package io.security.springsecuritymaster.method;

import org.aopalliance.intercept.MethodInvocation;
import org.springframework.security.authentication.AnonymousAuthenticationToken;
import org.springframework.security.authorization.AuthorizationDecision;
import org.springframework.security.authorization.AuthorizationManager;
import org.springframework.security.core.Authentication;

import java.util.function.Supplier;

public class MyPreAuthorizationManager implements AuthorizationManager<MethodInvocation> {

    @Override
    public AuthorizationDecision check(Supplier<Authentication> authentication, MethodInvocation invocation) {

        Authentication auth = authentication.get();

        if(auth instanceof AnonymousAuthenticationToken) return new AuthorizationDecision(false);

        return new AuthorizationDecision(auth.isAuthenticated());
    }
}
```

2. MyPostAuthorizationManager
```java
package io.security.springsecuritymaster.method;

import io.security.springsecuritymaster.Account;
import org.springframework.security.authentication.AnonymousAuthenticationToken;
import org.springframework.security.authorization.AuthorizationDecision;
import org.springframework.security.authorization.AuthorizationManager;
import org.springframework.security.authorization.method.MethodInvocationResult;
import org.springframework.security.core.Authentication;

import java.util.function.Supplier;

public class MyPostAuthorizationManager implements AuthorizationManager<MethodInvocationResult> {

    @Override
    public AuthorizationDecision check(Supplier<Authentication> authentication, MethodInvocationResult result) {

        Authentication auth = authentication.get();

        if(auth instanceof AnonymousAuthenticationToken) return new AuthorizationDecision(false);

        Account account = (Account) result.getResult(); // resultëŠ” Account ê°ì²´ í¬í•¨í•˜ë¯€ë¡œ, ë°˜í™˜ ì‹¬ì‚¬ ì§„í–‰

        boolean isGranted = account.getOwner().equals(auth.getName());

        return new AuthorizationDecision(isGranted);
    }
}
```

3. ì‚¬ìš©ì ì •ì˜ AuthorizationManagerëŠ” ì—¬ëŸ¬ ê°œ ì¶”ê°€í•  ìˆ˜ ìˆìœ¼ë©°, ê·¸ëŸ´ ê²½ìš° ì²´ì¸ í˜•íƒœë¡œ ì—°ê²°ë˜ì–´ ê° ê¶Œí•œ ê²€ì‚¬ë¥¼ í•˜ê²Œ ë¨

-----
### ì¸í„°ì…‰í„° ìˆœì„œ ì§€ì •
-----
```java
public enum AuthorizationInterceptorsOrder {
    FIRST(Integer.MIN_VALUE),
    PRE_FILTER, // 100
    PRE_AUTHORIZE, // 200
    SECURED, // 300
    JSR250, // 400
    SECURE_RESULT(450),
    POST_AUTHORIZE(500), // 500
    POST_FILTER(600), // 600
    LAST(Integer.MAX_VALUE);

    ...
}
```

1. ë©”ì„œë“œ ë³´ì•ˆ ì• ë„ˆí…Œì´ì…˜ì— ëŒ€ì‘í•˜ëŠ” AOP ë©”ì„œë“œ ì¸í„°ì…‰í„°ë“¤ì€ AOP ì–´ë“œë°”ì´ì € ì²´ì¸ì—ì„œ íŠ¹ì • ìœ„ì¹˜ë¥¼ ì°¨ì§€
2. êµ¬ì²´ì ìœ¼ë¡œ @PreFilter ë©”ì„œë“œ ì¸í„°ì…‰í„°ì˜ ìˆœì„œëŠ” 100, @PreAuthorizeì˜ ìˆœì„œëŠ” 200 ë“±ìœ¼ë¡œ ì„¤ì •ë˜ì–´ ìˆìŒ
3. ì´ê²ƒì´ ì¤‘ìš”í•œ ì´ìœ ëŠ” @EnableTransactionManagementì™€ ê°™ì€ ë‹¤ë¥¸ AOP ê¸°ë°˜ ì• ë„ˆí…Œì´ì…˜ë“¤ì´ Integer.MAX_VALUEë¡œ ìˆœì„œê°€ ì„¤ì •ë˜ì–´ ìˆëŠ”ë°, ì´ë“¤ì€ ì–´ë“œë°”ì´ì € ì²´ì¸ì˜ ëì— ìœ„ì¹˜
4. ë§Œì•½ ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ë³´ë‹¤ ë¨¼ì € ë‹¤ë¥¸ ì–´ë“œë°”ì´ìŠ¤ê°€ ì‹¤í–‰ë˜ì–´ì•¼ í•  ê²½ìš°, ì˜ˆë¥¼ ë“¤ì–´ @Transactionalê³¼ @PostAuthorizeê°€ í•¨ê»˜ ì• ë„ˆí…Œì´ì…˜ ëœ ë©”ì„œë“œê°€ ìˆì„ ë•Œ, @PostAuthorizeê°€ ì‹¤í–‰ë  ë•Œ íŠ¸ëœì­ì…˜ì´ ì—¬ì „íˆ ì—´ë ¤ìˆì–´ì„œ, AccessDeniedExceptionì´ ë°œìƒí•˜ë©´ ë¡¤ë°±ì´ ì¼ì–´ë‚˜ê²Œ í•˜ê³  ì‹¶ì„ ìˆ˜ ìˆìŒ
5. ê·¸ë˜ì„œ ë©”ì„œë“œ ì¸ê°€ ì–´ë“œë°”ì´ìŠ¤ê°€ ì‹¤í–‰ë˜ê¸° ì „ì— íŠ¸ëœì­ì…˜ì„ ì—´ê¸° ìœ„í•´ì„œëŠ” @EnableTrnasactionManagementì˜ ìˆœì„œë¥¼ ì„¤ì •í•´ì•¼ í•¨
6. ğŸ’¡ @EnableTransactionManagement(order = 0)
   - ìœ„ì˜ order = 0 ì„¤ì •ì€ íŠ¸ëœì­ì…˜ ê´€ë¦¬ê°€ @PreFilter ì´ì „ì— ì‹¤í–‰ë˜ë„ë¡ í•˜ë©°, @Transactional ì• ë„ˆí…Œì´ì…˜ì´ ì ìš©ëœ ë©”ì„œë“œê°€ ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ì˜ @PostAuthorizeì™€ ê°™ì€ ë³´ì•ˆ ì• ë„ˆí…Œì´ì…˜ë³´ë‹¤ ë¨¼ì € ì‹¤í–‰ë˜ì–´ íŠ¸ëœì­ì…˜ì´ ì—´ë¦° ìƒíƒœì—ì„œ ë³´ì•ˆ ê²€ì‚¬ê°€ ì´ë£¨ì–´ì§ˆ ìˆ˜ ìˆë„ë¡ í•  ìˆ˜ ìˆìŒ
   - ì´ëŸ¬í•œ ì„¤ì •ì€ íŠ¸ëœì­ì…˜ ê´€ë¦¬ì™€ ë³´ì•ˆ ê²€ì‚¬ì˜ ìˆœì„œì— ë”°ë¥¸ ì˜ë„í•˜ì§€ ì•Šì€ ì‚¬ì´ë“œ ì´í™íŠ¸ ë°©ì§€ ê°€ëŠ¥
7. AuthorizationInterceptorsOrderë¥¼ ì‚¬ìš©í•˜ì—¬ ì¸í„°ì…‰í„° ê°„ ìˆœì„œ ì§€ì • ê°€ëŠ¥

-----
### ì½”ë“œ
-----
1. MethodSecurityConfig
```java
package io.security.springsecuritymaster.method;

import org.springframework.aop.Advisor;
import org.springframework.beans.factory.config.BeanDefinition;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Role;
import org.springframework.security.authorization.method.AuthorizationManagerAfterMethodInterceptor;
import org.springframework.security.authorization.method.AuthorizationManagerBeforeMethodInterceptor;
import org.springframework.security.config.annotation.method.configuration.EnableMethodSecurity;

@EnableMethodSecurity(prePostEnabled = false)
@Configuration
public class MethodSecurityConfig {

    @Bean
    @Role(BeanDefinition.ROLE_INFRASTRUCTURE)
    public Advisor preAuthorize() {
        return AuthorizationManagerBeforeMethodInterceptor.preAuthorize(new MyPreAuthorizationManager());
    }

    @Bean
    @Role(BeanDefinition.ROLE_INFRASTRUCTURE)
    public Advisor postAuthorize() {
        return AuthorizationManagerAfterMethodInterceptor.postAuthorize(new MyPostAuthorizationManager());
    }
}
```

2. MyPreAuthorizationManager
```java
package io.security.springsecuritymaster.method;

import org.aopalliance.intercept.MethodInvocation;
import org.springframework.security.authentication.AnonymousAuthenticationToken;
import org.springframework.security.authorization.AuthorizationDecision;
import org.springframework.security.authorization.AuthorizationManager;
import org.springframework.security.core.Authentication;

import java.util.function.Supplier;

public class MyPreAuthorizationManager implements AuthorizationManager<MethodInvocation> {
    @Override
    public AuthorizationDecision check(Supplier<Authentication> authentication, MethodInvocation object) {
        Authentication auth = authentication.get();

        if(auth instanceof AnonymousAuthenticationToken) return new AuthorizationDecision(false);

        return new AuthorizationDecision(auth.isAuthenticated());
    }
}
```

3. MyPostAuthorizationManager
```java
package io.security.springsecuritymaster.method;

import io.security.springsecuritymaster.Account;
import org.springframework.security.authentication.AnonymousAuthenticationToken;
import org.springframework.security.authorization.AuthorizationDecision;
import org.springframework.security.authorization.AuthorizationManager;
import org.springframework.security.authorization.method.MethodInvocationResult;
import org.springframework.security.core.Authentication;

import java.util.function.Supplier;

public class MyPostAuthorizationManager implements AuthorizationManager<MethodInvocationResult> {
    @Override
    public AuthorizationDecision check(Supplier<Authentication> authentication, MethodInvocationResult object) {
        Authentication auth = authentication.get();

        if(auth instanceof AnonymousAuthenticationToken) return new AuthorizationDecision(false);

        Account account = (Account) object.getResult();

        boolean isGranted = account.getOwner().equals(auth.getName());

        return new AuthorizationDecision(isGranted);
    }
}
```


