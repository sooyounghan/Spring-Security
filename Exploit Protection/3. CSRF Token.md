-----
### CSRF í† í° ìœ ì§€ - CsrfTokenRepository
-----
1. CsrfTokenì€ CsrfTokenRepositoryë¥¼ ì‚¬ìš©í•˜ì—¬ ì˜ì†í™”í•˜ë©°, HttpSessionCsrfTokenRepositoryì™€ CookieCsrfTokenRepositoryë¥¼ ì§€ì›
2. ë‘ êµ°ë° ì¤‘ ì›í•˜ëŠ” ìœ„ì¹˜ì— í† í°ì„ ì €ì¥í•˜ë„ë¡ ì„¤ì •ì„ í†µí•´ ì§€ì • ê°€ëŠ¥

3. ì„¸ì…˜ì— í† í° ì €ì¥ - HttpSessionCsrfTokenRepository
```java
@Bean
SecurityFilterChain defaultSecurityFilterChain(HttpSecurity http) throws Exception {

    HttpSessionCsrfTokenRepository repository = new HttpSessionCsrfTokenRepository();
    http.csrf(csrf -> csrf.csrfTokenRepository(repository));

    return http.build();
}
```
  - ê¸°ë³¸ì ìœ¼ë¡œ í† í°ì„ ì„¸ì…˜ì— ì €ì¥í•˜ê¸° ìœ„í•´ HttpSessionCsrfTokenRepositoryë¥¼ ì‚¬ìš©
  - HttpSessionCsrfTokenRepositoryëŠ” ê¸°ë³¸ì ìœ¼ë¡œ HTTP ìš”ì²­ í—¤ë”ì¸ X-CSRF-TOKEN ë˜ëŠ” ìš”ì²­ ë§¤ê°œë³€ìˆ˜ì¸ _csrfì—ì„œ í† í°ì„ ì½ìŒ
<div align="center">
<img src="https://github.com/user-attachments/assets/8e836094-34b2-458f-b034-3292b2f8143d">
</div>

4. ì¿ í‚¤ì— í† í° ì €ì¥ - CookieCsrfTokenRepository
```java
@Bean
SecurityFilterChain defaultSecurityFilterChain(HttpSecurity http) throws Exception {

    CookieCsrfTokenRepository repository = new CookieCsrfTokenRepository();
    http.csrf(csrf -> csrf.csrfTokenRepository(repository));
    http.csrf(csrf -> csrf.csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse());

    return http.build();
}
```
  - JavaScript ê¸°ë°˜ ì• í”Œë¦¬ì¼€ì´ì…˜ ì§€ì›ì„ ìœ„í•´ CsrfTokenì„ ì¿ í‚¤ì— ìœ ì§€í•  ìˆ˜ ìˆìœ¼ë©° êµ¬í˜„ì²´ë¡œ CookieCsrfTokenRepositoryë¥¼ ì‚¬ìš©
  - CookieCsrfTokenRepositoryëŠ” ê¸°ë³¸ì ìœ¼ë¡œ XSRF-TOKEN ëª…ì„ ê°€ì§„ ì¿ í‚¤ì— ì‘ì„±í•˜ê³ , HTTP ìš”ì²­ í—¤ë”ì¸ X-XSRF-TOKEN ë˜ëŠ” ìš”ì²­ ë§¤ê°œë³€ìˆ˜ì¸ _csrfì—ì„œ ì½ìŒ
<div align="center">
<img src="https://github.com/user-attachments/assets/648ba454-8898-4ccf-80f0-8bf0037a3007">
</div>

  - JavaScriptì—ì„œ ì¿ í‚¤ë¥¼ ì½ì„ ìˆ˜ ìˆë„ë¡ HttpOnlyë¥¼ ëª…ì‹œì ìœ¼ë¡œ falseë¡œ ì„¤ì •
  - JavaScriptë¡œ ì§ì ‘ ì¿ í‚¤ë¥¼ ì½ì„ í•„ìš”ê°€ ì—†ëŠ” ê²½ìš° ë³´ì•ˆì„ ê°œì„ í•˜ê¸° ìœ„í•´ HttpOnlyë¥¼ ìƒëµí•˜ëŠ” ê²ƒì´ ì¢‹ìŒ

-----
### CSRF í† í° ì²˜ë¦¬ - CsrfTokenRequestHandler
-----
1. CsrfTokenì€ CsrfTokenRequestHandlerë¥¼ ì‚¬ìš©í•˜ì—¬ í† í°ì„ ìƒì„± ë° ì‘ë‹µí•˜ê³  HTTP í—¤ë” ë˜ëŠ” ìš”ì²­ ë§¤ê°œë³€ìˆ˜ë¡œë¶€í„° í† í°ì˜ ìœ íš¨ì„±ì„ ê²€ì¦í•˜ë„ë¡ í•¨
2. XorCsrfTokenRequestAttributeHandlerì™€ CsrfTokenRequestAttributeHandlerë¥¼ ì œê³µí•˜ë©° ì‚¬ìš©ì ì •ì˜ í•¸ë“¤ëŸ¬ë¥¼ êµ¬í˜„í•  ìˆ˜ ìˆìŒ
```java
@Bean
SecurityFilterChain defaultSecurityFilterChain(HttpSecurity http) throws Exception {

    XorCsrfTokenRequestAttributeHandler csrfTokenHandler = new XorCsrfTokenRequestAttributeHandler();
    http.csrf(csrf -> csrf.csrfTokenRequestHandler(csrfTokenHandlder));

    return http.build();
}
```

  - "_csrf" ë° CsrfToken.class.getName() ëª…ìœ¼ë¡œ HttpServletRequest ì†ì„±ì— CsrfTokenì„ ì €ì¥í•˜ë©° HttpServletRequestë¡œë¶€í„° CsrfTokenì„ êº¼ë‚´ì–´ ì°¸ì¡°í•  ìˆ˜ ìˆìŒ
  - í† í° ê°’ì„ ìš”ì²­ í—¤ë” (ê¸°ë³¸ì ìœ¼ë¡œ X-CSRF-TOKEN ë˜ëŠ” X-XSRF-TOKEN ì¤‘ í•˜ë‚˜) ë˜ëŠ” ìš”ì²­ ë§¤ê°œë³€ìˆ˜(_csrf) ì¤‘ í•˜ë‚˜ë¡œë¶€í„° í† í°ì˜ ìœ íš¨ì„± ë¹„êµ ë° ê²€ì¦ì„ í•´ê²°
  - ğŸ’¡ ì¤‘ìš” : í´ë¼ì´ì–¸íŠ¸ì˜ ë§¤ ìš”ì²­ë§ˆë‹¤ CSRF í† í° ê°’(UUID)ì— ë‚œìˆ˜ë¥¼ ì¸ì½”ë”©í•˜ì—¬ ë³€ê²½í•œ CsrfTokenì´ ë°˜í™˜ë˜ë„ë¡ ë³´ì¥í•˜ë©°, ì„¸ì…˜ì— ì €ì¥ëœ ì›ë³¸ í† í° ê°’ì€ ê·¸ëŒ€ë¡œ ìœ ì§€
  - ğŸ’¡ ì¤‘ìš” : í—¤ë” ê°’ ë˜ëŠ” ìš”ì²­ ë§¤ê°œë³€ìˆ˜ë¡œ ì „ë‹¬ëœ ì¸ì½”ë”© ëœ í† í°ì€ ì›ë³¸ í† í°ì„ ì–»ê¸° ìœ„í•´ ë””ì½”ë”©ë˜ë©°, ê·¸ëŸ° ë‹¤ìŒ ì„¸ì…˜ í˜¹ì€ ì¿ í‚¤ì— ì €ì¥ëœ ì˜êµ¬ì ì¸ CsrfTokenê³¼ ë¹„êµë¨

-----
### CSRF í† í° ì§€ì—° ë¡œë”©
-----
1. ê¸°ë³¸ì ìœ¼ë¡œ Spring SecurityëŠ” CsrfTokenì„ í•„ìš”í•  ë•Œ ê¹Œì§€ ë¡œë”©ì„ ì§€ì—°ì‹œí‚¤ëŠ” ì „ëµì„ ì‚¬ìš©
2. ê·¸ëŸ¬ë¯€ë¡œ CsrfTokenì€ HttpSessionì— ì €ì¥ë˜ì–´ ìˆê¸° ë•Œë¬¸ì— ë§¤ ìš”ì²­ë§ˆë‹¤ ì„¸ì…˜ìœ¼ë¡œë¶€í„° CsrfTokenì„ ë¡œë“œí•  í•„ìš”ê°€ ì—†ì–´ì ¸ ì„±ëŠ¥ì„ í–¥ìƒì‹œí‚¬ ìˆ˜ ìˆìŒ
3. CsrfTokenì€ POSTì™€ ê°™ì€ ì•ˆì „í•˜ì§€ ì•Šì€ HTTP ë©”ì„œë“œë¥¼ ì‚¬ìš©í•˜ì—¬ ìš”ì²­ì´ ë°œìƒí•  ë•Œì™€ CSRF í† í°ì„ ì‘ë‹µì— ë Œë”ë§í•˜ëŠ” ëª¨ë“  ìš”ì²­ì—ì„œ í•„ìš”í•˜ê¸° ë•Œë¬¸ì— ê·¸ ì™¸ ìš”ì²­ì—ëŠ” ì§€ì—° ë¡œë”©í•˜ëŠ” ê²ƒì´ ê¶Œì¥
```java
@Bean
SecurityFilterChain defaultSecurityFilterChain(HttpSecurity http) throws Exception {

    XorCsrfTokenRequestAttributeHandler handler = new XorCsrfTokenRequestAttributeHandler();
    handler.setCsrfRequestAttributeName(null); // ğŸ’¡ ì§€ì—°ëœ í† í°ì„ ì‚¬ìš©í•˜ì§€ ì•Šê³  CsrfTokenì„ ë§¤ ìš”ì²­ë§ˆë‹¤ ë¡œë“œ

    http.csrf(csrf -> csrf
        .csrfTokenRequestHandler(handler));

    return http.build();
}
```

-----
### ì½”ë“œ
-----
1. GET ë°©ì‹ ìš”ì²­
   - csrf.http
```http
### GET request with a header
GET http://localhost:9090
Accept: application/json
```

   - CsrfFilter
```java
protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException {
        DeferredCsrfToken deferredCsrfToken = this.tokenRepository.loadDeferredToken(request, response);
        request.setAttribute(DeferredCsrfToken.class.getName(), deferredCsrfToken);
        CsrfTokenRequestHandler var10000 = this.requestHandler;
        Objects.requireNonNull(deferredCsrfToken);
        var10000.handle(request, response, deferredCsrfToken::get);
        if (!this.requireCsrfProtectionMatcher.matches(request)) { // Request ê°ì²´ë¡œë¶€í„° ì •ë³´ ë¹„êµ
            if (this.logger.isTraceEnabled()) {
                this.logger.trace("Did not protect against CSRF since request did not match " + this.requireCsrfProtectionMatcher);
            }

            filterChain.doFilter(request, response);
        } else {
            CsrfToken csrfToken = deferredCsrfToken.get();
            String actualToken = this.requestHandler.resolveCsrfTokenValue(request, csrfToken);
            if (!equalsConstantTime(csrfToken.getToken(), actualToken)) {
                boolean missingToken = deferredCsrfToken.isGenerated();
                this.logger.debug(LogMessage.of(() -> {
                    return "Invalid CSRF token found for " + UrlUtils.buildFullRequestUrl(request);
                }));
                AccessDeniedException exception = !missingToken ? new InvalidCsrfTokenException(csrfToken, actualToken) : new MissingCsrfTokenException(actualToken);
                this.accessDeniedHandler.handle(request, response, (AccessDeniedException)exception);
            } else {
                filterChain.doFilter(request, response);
            }
        }
}

private static final class DefaultRequiresCsrfMatcher implements RequestMatcher {
        private final HashSet<String> allowedMethods = new HashSet(Arrays.asList("GET", "HEAD", "TRACE", "OPTIONS"));

        private DefaultRequiresCsrfMatcher() {
        }

        public boolean matches(HttpServletRequest request) {
            return !this.allowedMethods.contains(request.getMethod()); // Requestê°€ ë³´ë‚¸ ìš”ì²­ ë°©ì‹ í™•ì¸
        }

        public String toString() {
            return "CsrfNotRequired " + this.allowedMethods;
        }
}
```

2. POST ë°©ì‹
```http
### POST request with a header
POST http://localhost:9090/csrf
Content-Type: application/json

```

   - CsrfFilter
```java
protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException {
        DeferredCsrfToken deferredCsrfToken = this.tokenRepository.loadDeferredToken(request, response); // RepositoryDeferredCsrfToken
        request.setAttribute(DeferredCsrfToken.class.getName(), deferredCsrfToken); // í•´ë‹¹ í† í°ì„ Requestì— ì €ì¥
        CsrfTokenRequestHandler var10000 = this.requestHandler; // XorCsrfTokenRequestAttributeHandler
        Objects.requireNonNull(deferredCsrfToken);
        var10000.handle(request, response, deferredCsrfToken::get);
        if (!this.requireCsrfProtectionMatcher.matches(request)) { // Request ê°ì²´ë¡œë¶€í„° ì •ë³´ ë¹„êµ
            if (this.logger.isTraceEnabled()) {
                this.logger.trace("Did not protect against CSRF since request did not match " + this.requireCsrfProtectionMatcher);
            }

            filterChain.doFilter(request, response);
        } else { // POST, DELETE, PUT
            CsrfToken csrfToken = deferredCsrfToken.get();
            String actualToken = this.requestHandler.resolveCsrfTokenValue(request, csrfToken); // XorCsrfTokenRequestAttributeHandlerì˜ resolveCsrfTokenValue
            if (!equalsConstantTime(csrfToken.getToken(), actualToken)) {
                boolean missingToken = deferredCsrfToken.isGenerated();
                this.logger.debug(LogMessage.of(() -> {
                    return "Invalid CSRF token found for " + UrlUtils.buildFullRequestUrl(request);
                }));
                AccessDeniedException exception = !missingToken ? new InvalidCsrfTokenException(csrfToken, actualToken) : new MissingCsrfTokenException(actualToken);
                this.accessDeniedHandler.handle(request, response, (AccessDeniedException)exception);
            } else {
                filterChain.doFilter(request, response);
            }
        }
}

private static final class DefaultRequiresCsrfMatcher implements RequestMatcher {
        private final HashSet<String> allowedMethods = new HashSet(Arrays.asList("GET", "HEAD", "TRACE", "OPTIONS"));

        private DefaultRequiresCsrfMatcher() {
        }

        public boolean matches(HttpServletRequest request) {
            return !this.allowedMethods.contains(request.getMethod()); // Requestê°€ ë³´ë‚¸ ìš”ì²­ ë°©ì‹ í™•ì¸
        }

        public String toString() {
            return "CsrfNotRequired " + this.allowedMethods;
        }
}
```

  - DefferedCsrfToken
```java
package org.springframework.security.web.csrf;

public interface DeferredCsrfToken {
    CsrfToken get();

    boolean isGenerated();
}
```

  - êµ¬í˜„ì²´ : RepositoryDeferredCsrfToken
```java
package org.springframework.security.web.csrf;

import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;

final class RepositoryDeferredCsrfToken implements DeferredCsrfToken {
    private final CsrfTokenRepository csrfTokenRepository;
    private final HttpServletRequest request;
    private final HttpServletResponse response;
    private CsrfToken csrfToken; // ì‹¤ì œ CSRF í† í° ê°’ì„ ê°€ì§€ê³  ìˆìŒ
    private boolean missingToken;

    RepositoryDeferredCsrfToken(CsrfTokenRepository csrfTokenRepository, HttpServletRequest request, HttpServletResponse response) {
        this.csrfTokenRepository = csrfTokenRepository;
        this.request = request;
        this.response = response;
    }

    public CsrfToken get() { // get ë©”ì„œë“œë¥¼ í†µí•´ ì´ˆê¸°í™” ì‹¤í–‰
        this.init();
        return this.csrfToken;
    }

    public boolean isGenerated() {
        this.init();
        return this.missingToken;
    }

    private void init() {
        if (this.csrfToken == null) {
            this.csrfToken = this.csrfTokenRepository.loadToken(this.request); // Request ê°ì²´ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
            this.missingToken = this.csrfToken == null;
            if (this.missingToken) {
                this.csrfToken = this.csrfTokenRepository.generateToken(this.request); // í† í° ìƒì„±
                this.csrfTokenRepository.saveToken(this.csrfToken, this.request, this.response); // ì„¸ì…˜ì— ì €ì¥
            }

        }
    }
}
```

  - HttpSessionCsrfTokenRepository
```java
public CsrfToken loadToken(HttpServletRequest request) {
        HttpSession session = request.getSession(false);
        return session == null ? null : (CsrfToken)session.getAttribute(this.sessionAttributeName);
    }

    public CsrfToken generateToken(HttpServletRequest request) {
        return new DefaultCsrfToken(this.headerName, this.parameterName, this.createNewToken()); // X-CSRF-TOKEN, x_csrf


    private String createNewToken() {
        return UUID.randomUUID().toString();
    }
}
```

  - CsrfTokenRequestHandler êµ¬í˜„ì²´ : XorCsrfTokenRequestAttributeHandler
```java
public void handle(HttpServletRequest request, HttpServletResponse response, Supplier<CsrfToken> deferredCsrfToken) {
    Assert.notNull(request, "request cannot be null");
    Assert.notNull(response, "response cannot be null");
    Assert.notNull(deferredCsrfToken, "deferredCsrfToken cannot be null");
    Supplier<CsrfToken> updatedCsrfToken = this.deferCsrfTokenUpdate(deferredCsrfToken); // ìµœëŒ€í•œ ì‹¤í–‰ ì‹œì  ì§€ì—°
    super.handle(request, response, updatedCsrfToken);
}

private Supplier<CsrfToken> deferCsrfTokenUpdate(Supplier<CsrfToken> csrfTokenSupplier) { // ìµœëŒ€í•œ ì‹¤í–‰ ì‹œì  ì§€ì—°
        return new CachedCsrfTokenSupplier(() -> {
            CsrfToken csrfToken = (CsrfToken)csrfTokenSupplier.get();
            Assert.state(csrfToken != null, "csrfToken supplier returned null");
            String updatedToken = createXoredCsrfToken(this.secureRandom, csrfToken.getToken()); 
            return new DefaultCsrfToken(csrfToken.getHeaderName(), csrfToken.getParameterName(), updatedToken);
        });
}

public String resolveCsrfTokenValue(HttpServletRequest request, CsrfToken csrfToken) {
        String actualToken = super.resolveCsrfTokenValue(request, csrfToken); // CsrfTokenRequestHandler
        return getTokenValue(actualToken, csrfToken.getToken());
}
```

  -  CsrfTokenRequestHandler ì¸í„°í˜ì´ìŠ¤
```java
default String resolveCsrfTokenValue(HttpServletRequest request, CsrfToken csrfToken) {
        Assert.notNull(request, "request cannot be null");
        Assert.notNull(csrfToken, "csrfToken cannot be null");
        String actualToken = request.getHeader(csrfToken.getHeaderName()); // Header ì´ë¦„ìœ¼ë¡œ ì–»ì–´ì˜¤ê¸° (X-CSRF-TOKEN)
        if (actualToken == null) {
            actualToken = request.getParameter(csrfToken.getParameterName()); // Headerê°€ ì—†ë‹¤ë©´ Parameter(_csrf)
        }

        return actualToken;
}
```

  -  CsrfTokenRequestHandler êµ¬í˜„ì²´ : CsrfTokenRequestAttributeHandler (XorCsrfTokenRequestAttributeHandler ë¶€ëª¨ í´ë˜ìŠ¤)
```java
public void handle(HttpServletRequest request, HttpServletResponse response, Supplier<CsrfToken> deferredCsrfToken) {
        Assert.notNull(request, "request cannot be null");
        Assert.notNull(response, "response cannot be null");
        Assert.notNull(deferredCsrfToken, "deferredCsrfToken cannot be null");
        request.setAttribute(HttpServletResponse.class.getName(), response);
        CsrfToken csrfToken = new SupplierCsrfToken(deferredCsrfToken); // ì§€ì—°ëœ í† í°
        request.setAttribute(CsrfToken.class.getName(), csrfToken); // Request ê°ì²´ì— CsrfTokenì˜ ì´ë¦„ìœ¼ë¡œ ì €ì¥
        String csrfAttrName = this.csrfRequestAttributeName != null ? this.csrfRequestAttributeName : csrfToken.getParameterName();
        request.setAttribute(csrfAttrName, csrfToken); // _csrfë¼ëŠ” ë¬¸ìì—´ë¡œ í† í° ì €ì¥
}
```

  - Csrf í† í° êµ¬í˜„ì²´ : DefaultCsrfToken
```java
package org.springframework.security.web.csrf;

import org.springframework.util.Assert;

public final class DefaultCsrfToken implements CsrfToken {
    private final String token; // ë¬¸ìì—´ë¡œ ì €ì¥ëœ í† í° ê°’
    private final String parameterName; // íŒŒë¼ë¯¸í„°ë¡œ ê²€ìƒ‰
    private final String headerName; // í—¤ë”ë¡œ ê²€ìƒ‰

    public DefaultCsrfToken(String headerName, String parameterName, String token) {
        Assert.hasLength(headerName, "headerName cannot be null or empty");
        Assert.hasLength(parameterName, "parameterName cannot be null or empty");
        Assert.hasLength(token, "token cannot be null or empty");
        this.headerName = headerName;
        this.parameterName = parameterName;
        this.token = token;
    }

    public String getHeaderName() {
        return this.headerName;
    }

    public String getParameterName() {
        return this.parameterName;
    }

    public String getToken() {
        return this.token;
    }
}
```

3. CsrfTokenRepository
    - SecurityConfig
```java
package io.security.springsecuritymaster;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.Customizer;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.core.userdetails.User;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.provisioning.InMemoryUserDetailsManager;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.csrf.CookieCsrfTokenRepository;

@EnableWebSecurity
@Configuration
public class SecurityConfig {

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {

        CookieCsrfTokenRepository csrfTokenRepository = new CookieCsrfTokenRepository();
        
        http
                .authorizeHttpRequests(auth -> auth
                        .requestMatchers("/csrf").permitAll()
                        .anyRequest().authenticated())
                .formLogin(Customizer.withDefaults())
                .csrf(csrf -> csrf.csrfTokenRepository(csrfTokenRepository));
                // .csrf(csrf -> csrf.csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse()));
        return http.build();
    }

    @Bean
    public UserDetailsService userDetailsService() {
        UserDetails user = User.withUsername("user")
                .password("{noop}1111")
                .roles("USER")
                .build();

        return new InMemoryUserDetailsManager(user);
    }
}
```

   - CookieCsrfTokenRepository
```java
static final String DEFAULT_CSRF_COOKIE_NAME = "XSRF-TOKEN";
static final String DEFAULT_CSRF_PARAMETER_NAME = "_csrf";
static final String DEFAULT_CSRF_HEADER_NAME = "X-XSRF-TOKEN";
private static final String CSRF_TOKEN_REMOVED_ATTRIBUTE_NAME = CookieCsrfTokenRepository.class.getName().concat(".REMOVED");
private String parameterName = "_csrf";
private String headerName = "X-XSRF-TOKEN";
private String cookieName = "XSRF-TOKEN";

@Deprecated(
    since = "6.1"
)
public void setCookieDomain(String cookieDomain) {
    this.cookieDomain = cookieDomain;
}

/** @deprecated */
@Deprecated(
    since = "6.1"
)
public void setSecure(Boolean secure) {
    this.secure = secure;
}

/** @deprecated */
@Deprecated(
    since = "6.1"
)
public void setCookieMaxAge(int cookieMaxAge) {
    Assert.isTrue(cookieMaxAge != 0, "cookieMaxAge cannot be zero");
    this.cookieMaxAge = cookieMaxAge;
}

...
```

<div align="center">
<img src="https://github.com/user-attachments/assets/7df1fd78-6c72-4b4b-9cca-3c39788ec966">
</div>

  - XorCsrfTokenRequestAttributeHandler ì‚¬ìš©
```java
package io.security.springsecuritymaster;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.Customizer;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.core.userdetails.User;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.provisioning.InMemoryUserDetailsManager;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.csrf.CookieCsrfTokenRepository;
import org.springframework.security.web.csrf.XorCsrfTokenRequestAttributeHandler;

@EnableWebSecurity
@Configuration
public class SecurityConfig {

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {

        XorCsrfTokenRequestAttributeHandler csrfTokenRequestAttributeHandler = new XorCsrfTokenRequestAttributeHandler();
        
        http
                .authorizeHttpRequests(auth -> auth
                        .requestMatchers("/csrf").permitAll()
                        .anyRequest().authenticated())
                .formLogin(Customizer.withDefaults())
                .csrf(csrf -> csrf.csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse())
                        .csrfTokenRequestHandler(csrfTokenRequestAttributeHandler));
        return http.build();
    }

    @Bean
    public UserDetailsService userDetailsService() {
        UserDetails user = User.withUsername("user")
                .password("{noop}1111")
                .roles("USER")
                .build();

        return new InMemoryUserDetailsManager(user);
    }
}
```

4. CsrfToken ì‚¬ìš©
  - SecurityConfig
```java
package io.security.springsecuritymaster;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.Customizer;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.core.userdetails.User;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.provisioning.InMemoryUserDetailsManager;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.csrf.CookieCsrfTokenRepository;
import org.springframework.security.web.csrf.XorCsrfTokenRequestAttributeHandler;

@EnableWebSecurity
@Configuration
public class SecurityConfig {

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {

        http
                .authorizeHttpRequests(auth -> auth
                        .requestMatchers("/csrf", "/csrfToken").permitAll()
                        .anyRequest().authenticated())
                .formLogin(Customizer.withDefaults());

        return http.build();
    }

    @Bean
    public UserDetailsService userDetailsService() {
        UserDetails user = User.withUsername("user")
                .password("{noop}1111")
                .roles("USER")
                .build();

        return new InMemoryUserDetailsManager(user);
    }
}
```

  - csrf.http
```
### Send GET request with json body
GET http://localhost:9090/csrfToken
Accept: application/json
```

  - IndexContorller
```java
package io.security.springsecuritymaster;

import jakarta.servlet.http.HttpServletRequest;
import lombok.RequiredArgsConstructor;
import org.springframework.security.authentication.AnonymousAuthenticationToken;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.annotation.CurrentSecurityContext;
import org.springframework.security.core.context.SecurityContext;
import org.springframework.security.web.csrf.CsrfToken;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequiredArgsConstructor
public class IndexController {
    @GetMapping("/")
    public Authentication index(Authentication authentication) {
        return authentication;
    }

    @GetMapping("/loginPage")
    public String loginPage() {
        return "loginPage";
    }

    @GetMapping("/home")
    public String home() {
        return "home";
    }

    @GetMapping("/anonymous")
    public String anonymous() {
        return "anonymous"; // ê¶Œí•œì„ ê°€ì§„ í›„ ì ‘ê·¼í•˜ë ¤í•˜ë©´, ì ‘ê·¼ ë¶ˆê°€ (ì´ë¯¸ ì¸ì¦ì„ ë°›ì•˜ìœ¼ë¯€ë¡œ)
    }

    @GetMapping("/authentication")
    public String authentication(Authentication authentication) { // Authentication ê°ì²´ë¥¼ íŒŒë¼ë¯¸í„°ë¡œ ë°›ìŒ (ìµëª… ê°ì²´ë¥¼ ì°¸ì¡°ë°›ì§€ ëª»í•˜ê³  ìˆìŒ)
        if(authentication instanceof AnonymousAuthenticationToken) { // ìµëª… ì‚¬ìš©ì ê°ì²´ë¼ë©´,
            return "anonymous";
        } else { // ì•„ë‹ˆë¼ë©´, Nullì´ë¯€ë¡œ ìµëª… ê°ì²´ ì°¸ì¡° ë¶ˆê°€
            return "not anonymous";
        }
    }

    @GetMapping("/anonymousContext") // ìµëª… ê°ì²´ ì°¸ì¡°
    public String anonymousContext(@CurrentSecurityContext SecurityContext securityContext) {
        return securityContext.getAuthentication().getName(); // í˜„ì¬ SecurityContextì—ì„œ ìµëª… ê°ì²´ë¥¼ ì°¸ì¡° ë°›ì•„ ì‚¬ìš©
    }

    @GetMapping("/logoutSuccess")
    public String logoutSuccess() {
        return "logoutSuccess";
    }

    @GetMapping("/invalidSessionUrl")
    public String invalidSessionUrl() {
        return "invalidSessionUrl";
    }

    @GetMapping("/expiredUrl")
    public String expiredUrl() {
        return "expiredUrl";
    }

    @GetMapping("/login")
    public String login() {
        return "login";
    }

    @GetMapping("/denied")
    public String denied() {
        return "denied";
    }

    @PostMapping("/csrf")
    public String csrf() {
        return "csrf ì ìš©ë¨";
    }

    @GetMapping("/csrfToken")
    public String csrfToken(HttpServletRequest request) {
        CsrfToken csrfToken1 = (CsrfToken) request.getAttribute(CsrfToken.class.getName()); // HEADER NAMEìœ¼ë¡œ ê°€ì ¸ì˜´
        CsrfToken csrfToken2 = (CsrfToken) request.getAttribute("_csrf"); // Parameter Nameìœ¼ë¡œ ê°€ì ¸ì˜´
        // ì§€ì—°ëœ CsrfTokenRepositoryì—ì„œ ìœ„ ìš”ì²­ ì‹œ ê°€ì ¸ì˜´

        String token = csrfToken1.getToken();

        return token;
    }
}
```

```
wYZSjSGp75icC5IaTms0KwBca0vI8aeWAumqPzTrU8Sj6zgcouAx7hHNifqxO6R5KEYATjk9RnLwwcK7ZovOCgPca6LG2w4u
```
