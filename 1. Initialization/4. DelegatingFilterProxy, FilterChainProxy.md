-----
### Filter
-----
1. ì„œë¸”ë¦¿ í•„í„°ëŠ” ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ í´ë¼ì´ì–¸íŠ¸ì˜ ìš”ì²­(ServletRequest)ê³¼ ì„œë²„ì˜ ì‘ë‹µ(ServletResponse)ì„ ê°€ê³µí•˜ê±°ë‚˜ ê²€ì‚¬í•˜ëŠ”ë° ì‚¬ìš©ë˜ëŠ” êµ¬ì„± ìš”ì†Œ
2. í´ë¼ì´ì–¸íŠ¸ì˜ ìš”ì²­ì´ ì„œë¸”ë¦¿ì— ë„ë‹¬í•˜ê¸° ì „ì´ë‚˜ ì„œë¸”ë¦¿ì´ ì‘ë‹µì„ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ë³´ë‚´ê¸° ì „ì— íŠ¹ì • ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŒ
3. ì„œë¸”ë¦¿ ì»¨í…Œì´ë„ˆ(WAS)ì—ì„œ ìƒì„±ë˜ê³  ì‹¤í–‰ë˜ê³  ì¢…ë£Œ
<div align="center">
<img src="https://github.com/user-attachments/assets/dded7a3d-f985-41e7-9920-18dec162425c">
</div>

-----
### DelegatingFilterProxy
-----
1. ìŠ¤í”„ë§ì—ì„œ ì‚¬ìš©ë˜ëŠ” íŠ¹ë³„í•œ ì„œë¸”ë¦¿ í•„í„°
2. ì„œë¸”ë¦¿ ì»¨í…Œì´ë„ˆì™€ ìŠ¤í”„ë§ ì• í”Œë¦¬ì¼€ì´ì…˜ ì»¨í…ìŠ¤íŠ¸ ê°„ì˜ ì—°ê²°ê³ ë¦¬ë¥¼ í•˜ëŠ” í•„í„°
3. ì„œë¸”ë¦¿ í•„í„°ì˜ ê¸°ëŠ¥ì„ ìˆ˜í–‰í•˜ëŠ” ë™ì‹œì— ìŠ¤í”„ë§ì˜ ì˜ì¡´ì„± ì£¼ì… ë° ë¹ˆ ê´€ë¦¬ ê¸°ëŠ¥ê³¼ ì—°ë™ë˜ë„ë¡ ì„¤ê³„ëœ í•„í„°
4. "springSecurityFilterChain" ì´ë¦„ìœ¼ë¡œ ìƒì„±ëœ ë¹ˆ(=FilterChainPrxoy)ì„ ApplicationContextì—ì„œ ì°¾ì•„ ìš”ì²­ ìœ„ì„
5. ì‹¤ì œ ë³´ì•ˆ ì²˜ë¦¬ë¥¼ ìˆ˜í–‰í•˜ì§€ ì•ŠìŒ
<div align="center">
<img src="https://github.com/user-attachments/assets/d228fc79-5f5e-404b-8456-b94dd6bd2544">
</div>

-----
### FilterChainProxy
-----
1. ğŸ’¡ springSecurityFilterChainì˜ ì´ë¦„ìœ¼ë¡œ ìƒì„±ë˜ëŠ” í•„í„° ë¹ˆìœ¼ë¡œì„œ DelegatingFilterProxyìœ¼ë¡œë¶€í„° ìš”ì²­ì„ ìœ„ì„ ë°›ê³  ë³´ì•ˆ ì²˜ë¦¬ ì—­í• 
2. ë‚´ë¶€ì ìœ¼ë¡œ í•˜ë‚˜ ì´ìƒì˜ SecurityFilterChain ê°ì²´ë“¤ì„ ê°€ì§€ê³  ìˆìœ¼ë©°, ìš”ì²­ URL ì •ë³´ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì ì ˆí•œ SecurityFilterChainì„ ì„ íƒí•´ í•„í„° í˜¸ì¶œ
3. HttpSecurityë¥¼ í†µí•´ API ì¶”ê°€ ì‹œ ê´€ë ¨ í•„í„°ë“¤ì„ ì¶”ê°€ë¨
4. ì‚¬ìš©ìì˜ ìš”ì²­ì„ í•„í„° ìˆœì„œëŒ€ë¡œ í˜¸ì¶œí•¨ìœ¼ë¡œ ë³´ì•ˆ ê¸°ëŠ¥ì„ ë™ì‘ì‹œí‚¤ê³  í•„ìš” ì‹œ ì§ì ‘ í•„í„°ë¥¼ ìƒì„±í•´ ê¸°ì¡´ì˜ í•„í„° ì „ / í›„ë¡œ ì¶”ê°€ ê°€ëŠ¥
<div align="center">
<img src="https://github.com/user-attachments/assets/2a21e2a0-e0f9-4b1f-8521-b86bc847a0b2">
</div>

<div align="center">
<img src="https://github.com/user-attachments/assets/c3a28c4b-07a5-4c6c-8d82-f1a00bf9090e">
</div>

  - 0ë²ˆì§¸ í•„í„°ë¶€í„° 15ë²ˆì§¸ í•„í„°ê¹Œì§€ ìœ„ì—ì„œ ìˆœì„œëŒ€ë¡œ í˜¸ì¶œí•˜ë©´ì„œ ìš”ì²­ ì²˜ë¦¬
  - ë§¨ ë§ˆì§€ë§‰ ì¸ê°€ ì²˜ë¦¬ë¥¼ í•˜ëŠ” í•„í„°ê¹Œì§€ íŠ¹ë³„í•œ ì˜ˆì™¸ë‚˜ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì§€ ì•Šìœ¼ë©´, ì„±ê³µì ìœ¼ë¡œ ìš”ì²­ì´ ì„œë¸”ë¦¿ìœ¼ë¡œ ë„˜ì–´ê°€ê²Œ ë¨

-----
### ì½”ë“œ
-----
1. SecurityFilterAutoConfiguration
```java
package org.springframework.boot.autoconfigure.security.servlet;

import jakarta.servlet.DispatcherType;
import java.util.EnumSet;
import java.util.stream.Collectors;
import org.springframework.boot.autoconfigure.AutoConfiguration;
import org.springframework.boot.autoconfigure.condition.ConditionalOnBean;
import org.springframework.boot.autoconfigure.condition.ConditionalOnClass;
import org.springframework.boot.autoconfigure.condition.ConditionalOnWebApplication;
import org.springframework.boot.autoconfigure.condition.ConditionalOnWebApplication.Type;
import org.springframework.boot.autoconfigure.security.SecurityProperties;
import org.springframework.boot.context.properties.EnableConfigurationProperties;
import org.springframework.boot.web.servlet.DelegatingFilterProxyRegistrationBean;
import org.springframework.boot.web.servlet.ServletRegistrationBean;
import org.springframework.context.annotation.Bean;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.web.context.AbstractSecurityWebApplicationInitializer;

@AutoConfiguration(
    after = {SecurityAutoConfiguration.class}
)
@ConditionalOnWebApplication(
    type = Type.SERVLET
)
@EnableConfigurationProperties({SecurityProperties.class})
@ConditionalOnClass({AbstractSecurityWebApplicationInitializer.class, SessionCreationPolicy.class})
public class SecurityFilterAutoConfiguration {
    private static final String DEFAULT_FILTER_NAME = "springSecurityFilterChain";

    public SecurityFilterAutoConfiguration() {
    }

    @Bean
    @ConditionalOnBean(
        name = {"springSecurityFilterChain"}
    )
    public DelegatingFilterProxyRegistrationBean securityFilterChainRegistration(SecurityProperties securityProperties) {

        // DelegatingFilterProxyRegistrationBean ìƒì„± (springSecurityFilterChain ì´ë¦„ìœ¼ë¡œ ë¹ˆ ìƒì„±)
        DelegatingFilterProxyRegistrationBean registration = new DelegatingFilterProxyRegistrationBean("springSecurityFilterChain", new ServletRegistrationBean[0]);

        registration.setOrder(securityProperties.getFilter().getOrder());
        registration.setDispatcherTypes(this.getDispatcherTypes(securityProperties));
        return registration;
    }

    ...
```

2. DelegatingFilterProxyRegistrationBean
```java
package org.springframework.boot.web.servlet;

import jakarta.servlet.ServletException;
import org.springframework.beans.BeansException;
import org.springframework.context.ApplicationContext;
import org.springframework.context.ApplicationContextAware;
import org.springframework.util.Assert;
import org.springframework.web.context.WebApplicationContext;
import org.springframework.web.filter.DelegatingFilterProxy;

public class DelegatingFilterProxyRegistrationBean extends AbstractFilterRegistrationBean<DelegatingFilterProxy> implements ApplicationContextAware {
    private ApplicationContext applicationContext;
    private final String targetBeanName;

    public DelegatingFilterProxyRegistrationBean(String targetBeanName, ServletRegistrationBean<?>... servletRegistrationBeans) {
        super(servletRegistrationBeans);
        Assert.hasLength(targetBeanName, "TargetBeanName must not be null or empty");
        this.targetBeanName = targetBeanName;
        this.setName(targetBeanName);
    }

    ...

    public DelegatingFilterProxy getFilter() {
        return new DelegatingFilterProxy(this.targetBeanName, this.getWebApplicationContext()) { // DelegatingFilterProxy ìƒì„±
            protected void initFilterBean() throws ServletException {
            }
        };
    }

    ...
```

3. AbstractFilterRegistrationBean
```java
package org.springframework.boot.web.servlet;

import jakarta.servlet.DispatcherType;
import jakarta.servlet.Filter;
import jakarta.servlet.FilterRegistration;
import jakarta.servlet.ServletContext;
import java.util.Arrays;
import java.util.Collection;
import java.util.Collections;
import java.util.EnumSet;
import java.util.Iterator;
import java.util.LinkedHashSet;
import java.util.Set;
import org.springframework.util.Assert;
import org.springframework.util.ClassUtils;
import org.springframework.util.StringUtils;
import org.springframework.web.filter.OncePerRequestFilter;

public abstract class AbstractFilterRegistrationBean<T extends Filter> extends DynamicRegistrationBean<FilterRegistration.Dynamic> {
    private static final String[] DEFAULT_URL_MAPPINGS = new String[]{"/*"};
    private Set<ServletRegistrationBean<?>> servletRegistrationBeans = new LinkedHashSet();
    private Set<String> servletNames = new LinkedHashSet();
    private Set<String> urlPatterns = new LinkedHashSet();
    private EnumSet<DispatcherType> dispatcherTypes;
    private boolean matchAfter = false;

    ...

    protected FilterRegistration.Dynamic addRegistration(String description, ServletContext servletContext) {
        Filter filter = this.getFilter();
        return servletContext.addFilter(this.getOrDeduceName(filter), filter); // ì„œë¸”ë¦¿ ì»¨í…Œì´ë„ˆì— ì¶”ê°€
    }

    ...
}
```

4. WebSecurityê°€ FilterChainProxy ìƒì„±
```java
@Bean(
    name = {"springSecurityFilterChain"} // ë¹ˆ ì´ë¦„ ì£¼ëª© (springSecurityFilterChain)
)
public Filter springSecurityFilterChain() throws Exception {
    boolean hasFilterChain = !this.securityFilterChains.isEmpty();
    if (!hasFilterChain) {
        this.webSecurity.addSecurityFilterChainBuilder(() -> {
            this.httpSecurity.authorizeHttpRequests((authorize) -> {
                ((AuthorizeHttpRequestsConfigurer.AuthorizedUrl)authorize.anyRequest()).authenticated();
            });
            this.httpSecurity.formLogin(Customizer.withDefaults());
            this.httpSecurity.httpBasic(Customizer.withDefaults());
            return (SecurityFilterChain)this.httpSecurity.build();
        });
    }

    Iterator var2 = this.securityFilterChains.iterator();

    while(var2.hasNext()) {
        SecurityFilterChain securityFilterChain = (SecurityFilterChain)var2.next();
        this.webSecurity.addSecurityFilterChainBuilder(() -> {
            return securityFilterChain;
        });
    }

    var2 = this.webSecurityCustomizers.iterator();

    while(var2.hasNext()) {
        WebSecurityCustomizer customizer = (WebSecurityCustomizer)var2.next();
        customizer.customize(this.webSecurity);
    }

    return (Filter)this.webSecurity.build();
}
```

5. ì‹¤ì œ ìš”ì²­ì´ ë“¤ì–´ì˜¤ë©´, DelegatingFilterProxyì—ì„œ ìœ„ì„í•  í•„í„°ë¥¼ ì°¾ìŒ
```java
package org.springframework.web.filter;

import jakarta.servlet.Filter;
import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.ServletRequest;
import jakarta.servlet.ServletResponse;
import java.io.IOException;
import java.util.concurrent.locks.Lock;
import java.util.concurrent.locks.ReentrantLock;
import org.springframework.context.ConfigurableApplicationContext;
import org.springframework.lang.Nullable;
import org.springframework.util.Assert;
import org.springframework.web.context.WebApplicationContext;
import org.springframework.web.context.support.WebApplicationContextUtils;

public class DelegatingFilterProxy extends GenericFilterBean {
    @Nullable
    private String contextAttribute;
    @Nullable
    private WebApplicationContext webApplicationContext;
    @Nullable
    private String targetBeanName;
    private boolean targetFilterLifecycle;
    @Nullable
    private volatile Filter delegate;
    private final Lock delegateLock;

    ...

    public void doFilter(ServletRequest request, ServletResponse response, FilterChain filterChain) throws ServletException, IOException {
        Filter delegateToUse = this.delegate;
        if (delegateToUse == null) { // ìœ„ì„í•  í•„í„°ë¥¼ ì°¾ìŒ
            this.delegateLock.lock();

            try {
                delegateToUse = this.delegate;
                if (delegateToUse == null) { // ìœ„ì„ë˜ì§€ ì•Šì•˜ìœ¼ë©´,
                    WebApplicationContext wac = this.findWebApplicationContext(); // ì„œë¸”ë¦¿ ì»¨í…Œì´ë„ˆì—ì„œ ì°¾ìŒ
                    if (wac == null) {
                        throw new IllegalStateException("No WebApplicationContext found: no ContextLoaderListener or DispatcherServlet registered?");
                    }

                    delegateToUse = this.initDelegate(wac); // í•´ë‹¹ springSecurityFilterChianProxy ë¹ˆì„ ì°¾ìœ¼ë©´, initDelegate
                }

                this.delegate = delegateToUse;
            } finally {
                this.delegateLock.unlock();
            }
        }

        this.invokeDelegate(delegateToUse, request, response, filterChain);
    }

    ...

    protected Filter initDelegate(WebApplicationContext wac) throws ServletException {
        String targetBeanName = this.getTargetBeanName(); // springSecurityFilterChianProxy ë¹ˆ íƒ€ì¼“ ì´ë¦„ì„ ì°¾ìŒ
        Assert.state(targetBeanName != null, "No target bean name set");
        Filter delegate = (Filter)wac.getBean(targetBeanName, Filter.class); // springSecurityFilterChianProxy ë¹ˆì„ ê°€ì ¸ì˜´
        if (this.isTargetFilterLifecycle()) {
            delegate.init(this.getFilterConfig());
        }

        return delegate;
    }
```

6. FilterChainProxyê°€ Filterë¥¼ Chainìœ¼ë¡œ ì—°ê²°í•œ ê°€ìƒì˜ í•„í„° ì²´ì¸ì„ ê°€ì ¸ í•„í„° ë³´ê´€ (VirtualFilterChain)
```java
 private static final class VirtualFilterChain implements FilterChain {
      private final FilterChain originalChain;
      private final List<Filter> additionalFilters;
      private final int size;
      private int currentPosition = 0;
  
      private VirtualFilterChain(FilterChain chain, List<Filter> additionalFilters) {
          this.originalChain = chain;
          this.additionalFilters = additionalFilters;
          this.size = additionalFilters.size();
      }
  
      public void doFilter(ServletRequest request, ServletResponse response) throws IOException, ServletException {
          if (this.currentPosition == this.size) {
              this.originalChain.doFilter(request, response);
          } else {
              ++this.currentPosition;
              Filter nextFilter = (Filter)this.additionalFilters.get(this.currentPosition - 1);
              if (FilterChainProxy.logger.isTraceEnabled()) {
                  String name = nextFilter.getClass().getSimpleName();
                  FilterChainProxy.logger.trace(LogMessage.format("Invoking %s (%d/%d)", name, this.currentPosition, this.size));
              }
  
              nextFilter.doFilter(request, response, this);
          }
      }
}
```
  - FilterChainProxy
```java
 public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException {
        boolean clearContext = request.getAttribute(FILTER_APPLIED) == null;
        if (!clearContext) {
            this.doFilterInternal(request, response, chain); // í•„í„° ë‚´ë¶€ ë¡œì§
        } else {
            try {
                request.setAttribute(FILTER_APPLIED, Boolean.TRUE);
                this.doFilterInternal(request, response, chain); // í•„í„° ë‚´ë¶€ ë¡œì§
            } catch (Exception var11) {
                Exception ex = var11;
                Throwable[] causeChain = this.throwableAnalyzer.determineCauseChain(ex);
                Throwable requestRejectedException = this.throwableAnalyzer.getFirstThrowableOfType(RequestRejectedException.class, causeChain);
                if (!(requestRejectedException instanceof RequestRejectedException)) {
                    throw ex;
                }

                this.requestRejectedHandler.handle((HttpServletRequest)request, (HttpServletResponse)response, (RequestRejectedException)requestRejectedException);
            } finally {
                this.securityContextHolderStrategy.clearContext();
                request.removeAttribute(FILTER_APPLIED);
            }

        }
  }

private void doFilterInternal(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException {
    FirewalledRequest firewallRequest = this.firewall.getFirewalledRequest((HttpServletRequest)request);
    HttpServletResponse firewallResponse = this.firewall.getFirewalledResponse((HttpServletResponse)response);
    List<Filter> filters = this.getFilters((HttpServletRequest)firewallRequest);
    if (filters != null && !filters.isEmpty()) { // 16ê°œì˜ Filterë¥¼ ê°€ì ¸ì˜´
        if (logger.isDebugEnabled()) {
            logger.debug(LogMessage.of(() -> {
                return "Securing " + requestLine(firewallRequest);
            }));
        }

        FilterChain reset = (req, res) -> {
            if (logger.isDebugEnabled()) {
                logger.debug(LogMessage.of(() -> {
                    return "Secured " + requestLine(firewallRequest);
                }));
            }

            firewallRequest.reset();
            chain.doFilter(req, res);
        };
        this.filterChainDecorator.decorate(reset, filters).doFilter(firewallRequest, firewallResponse);
    } else {
        if (logger.isTraceEnabled()) {
            logger.trace(LogMessage.of(() -> {
                return "No security for " + requestLine(firewallRequest);
            }));
        }

        firewallRequest.reset();
        this.filterChainDecorator.decorate(chain).doFilter(firewallRequest, firewallResponse);
    }
}
```
```java
private static final class VirtualFilterChain implements FilterChain {
    private final FilterChain originalChain;
    private final List<Filter> additionalFilters;
    private final int size;
    private int currentPosition = 0;

    private VirtualFilterChain(FilterChain chain, List<Filter> additionalFilters) {
        this.originalChain = chain;
        this.additionalFilters = additionalFilters;
        this.size = additionalFilters.size();
    }

    public void doFilter(ServletRequest request, ServletResponse response) throws IOException, ServletException {
        if (this.currentPosition == this.size) {
            this.originalChain.doFilter(request, response);
        } else {
            ++this.currentPosition;
            Filter nextFilter = (Filter)this.additionalFilters.get(this.currentPosition - 1); // NextFilter, ì¦‰ 16ê°œì˜ í•„í„°ë¥¼ ë²ˆê°ˆì•„ í˜¸ì¶œ
            if (FilterChainProxy.logger.isTraceEnabled()) {
                String name = nextFilter.getClass().getSimpleName();
                FilterChainProxy.logger.trace(LogMessage.format("Invoking %s (%d/%d)", name, this.currentPosition, this.size));
            }

            nextFilter.doFilter(request, response, this); // í•„í„°ë¥¼ ë²ˆê°ˆì•„ê°€ë©° í˜¸ì¶œ
        }
    }
}
```

