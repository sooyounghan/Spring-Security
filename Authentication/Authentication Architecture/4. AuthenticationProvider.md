-----
### ì‹œíë¦¬í‹° ì¸ì¦ / ì¸ê°€ íë¦„ë„
-----
<div align="center">
<img src="https://github.com/user-attachments/assets/3be1859e-024b-4ac8-bfe7-d819b5411396">
</div>

-----
### AuthenticationProvider
-----
1. ì‚¬ìš©ìì˜ ìê·¹ ì¦ëª…ì„ í™•ì¸í•˜ê³ , ì¸ì¦ ê³¼ì •ì„ ê´€ë¦¬í•˜ëŠ” í´ë˜ìŠ¤ë¡œì„œ ì‚¬ìš©ìê°€ ì‹œìŠ¤í…œì— ì•¡ì„¸ìŠ¤í•˜ê¸° ìœ„í•´ ì œê³µí•œ ì •ë³´ (ì˜ˆ) ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸)ê°€ ìœ íš¨í•œì§€ ê²€ì¦í•˜ëŠ” ê³¼ì • í¬í•¨
2. ë‹¤ì–‘í•œ ìœ í˜•ì˜ ì¸ì¦ ë©”ì»¤ë‹ˆì¦˜ì„ ì§€ì›í•  ìˆ˜ ìˆëŠ”ë°, ì˜ˆë¥¼ ë“¤ì–´ í‘œì¤€ ì‚¬ìš©ìì˜ ì´ë¦„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•œ ì¸ì¦, í† í° ê¸°ë°˜ ì¸ì¦, ì§€ë¬¸ ì¸ì‹ ë“±ì„ ì²˜ë¦¬ ê°€ëŠ¥
3. ì„±ê³µì ì¸ ì¸ì¦ í›„ì—ëŠ” Authentication ê°ì²´ë¥¼ ë°˜í™˜í•˜ë©° ì´ ê°ì²´ì—ëŠ” ì‚¬ìš©ìì˜ ì‹ ì› ì •ë³´ì™€ ì¸ì¦ëœ ìê²© ì¦ëª…ì„ í¬í•¨
4. ì¸ì¦ ê³¼ì • ì¤‘ì—ëŠ” ë¬¸ì œê°€ ë°œìƒí•œ ê²½ìš° AuthenticationExceptionê³¼ ê°™ì€ ì˜ˆì™¸ë¥¼ ë°œìƒì‹œì¼œ ë¬¸ì œë¥¼ ì•Œë¦¬ëŠ” ì—­í• ì„ í•¨
<div align="center">
<img src="https://github.com/user-attachments/assets/f5b6d68f-174d-40a3-bbfc-53327eb98e6e">
</div>

  - authenticate(Authentication) : AuthenticationManagerë¡œë¶€í„° Authentication ê°ì²´ë¥¼ ì „ë‹¬ ë°›ì•„ ì¸ì¦ ìˆ˜í–‰
  - supports(Class```<?>```) : ì¸ì¦ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆëŠ” ì¡°ê±´ì¸ì§€ ê²€ì‚¬

-----
### AuthenticationProvider íë¦„ë„
-----
<div align="center">
<img src="https://github.com/user-attachments/assets/c6599e30-2f2a-4b64-b318-a1527b4b9377">
</div>

-----
### AuthenticationProvider ì‚¬ìš© ë°©ë²• - ì¼ë°˜ ê°ì²´ë¡œ ìƒì„± (Bean ê°ì²´ê°€ ì•„ë‹˜)
-----
```java
@Bean
public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
    // ëª¨ë‘ ë™ì¼í•œ ì²˜ë¦¬ (AuthenticationManagerBuilder ì ‘ê·¼) 
    AuthenticationManagerBuilder managerBuilder = http.getSharedObject(AuthenticationManagerBuilder.class);
    managerBuilder.authenticationProvider(new CustomAuthenticationProvider());
    // ëª¨ë‘ ë™ì¼í•œ ì²˜ë¦¬ (Http ì ‘ê·¼)
    http.authenticationProvider(new CustomAuthenticationProvider2());

    http.authorizeHttpRequests(auth -> auth.anyRequest().authenticated());
    http.formLogin(Customizer.withDefaults());

    return http.build();
}
```
<div align="center">
<img src="https://github.com/user-attachments/assets/9ec9ec56-5606-45b0-a52c-6bd3d4ad1a4f">
</div>

-----
### ğŸ’¡ AuthenticationProvider ì‚¬ìš© ë°©ë²• - Beanìœ¼ë¡œ ìƒì„±
-----
1. Beanì„ í•œ ê°œë§Œ ì •ì˜í•  ê²½ìš°
  - AuthenticationProviderë¥¼ ë¹ˆìœ¼ë¡œ ì •ì˜í•˜ë©´ DaoAuthenticationProviderë¥¼ ìë™ìœ¼ë¡œ ëŒ€ì²´
```java
@Bean
public AuthenticationProvider customAuthenticationProvider() {
    return new CustomAuthenticationProvider();
}
```
<div align="center">
<img src="https://github.com/user-attachments/assets/eb24e671-1ffb-480f-b9aa-9ac983f10078">
</div>

```java
@Bean
public SecurityFilterChain securityFilterChain(HttpSecurity http, AuthenticationManagerBuilder builder, AuthenticationConfiguration configuration) throws Exception {
    AuthenticationManagerBuilder managerBuilder = http.getSharedObject(AuthenticationManagerBuilder.class); // authenticationManager (ProviderManager)
    managerBuilder.authenticationProvider(customAuthenticationProvider()); // AuthenticationManagerVuilderë¥¼ í†µí•´ customAuthenticationProvider ì¶”ê°€
    ProviderManager providerManager = (ProviderManager) configuration.getAuthenticationManager(); // AuthenticationConfigurationì„ í†µí•´ AuthencticationManagerë¥¼ ì½ì–´ì˜´
    providerManager.getProviders().remove(0); // Managerë¡œë¶€í„° ì²« ë²ˆì§¸ ëª©ë¡ ì‚­ì œ (= ì¦‰, CustomAuthenticationProvider ì œê±°í•˜ëŠ”ë°, ì´ëŠ” parentë„ ì°¸ì¡°í•˜ë¯€ë¡œ ê°™ì´ ì‚­ì œ)
    builder.authenticationProvider(new DaoAuthenticationProvider()); // DaoAuthenticationProviderfmf ProviderManagerì— ì¶”ê°€(parent)

    http.authorizeHttpRequests(auth -> auth.anyRequest().authenticated());
    return http.build();
}
```
<div align="center">
<img src="https://github.com/user-attachments/assets/efc16f5d-5f25-4e84-b054-4f0816a91d83">
</div>

2. ë¹ˆì„ ë‘ ê°œ ì´ìƒ ì •ì˜í•  ê²½ìš°
```java
@Bean
public SecurityFilterChain securityFilterChain(HttpSecurity http) thorws Exception {
    AuthenticationManagerBuilder managerBuilder = http.getSharedObject(AuthenticationManagerBuilder.class);
    managerBuilder.authenticationProvider(customAuthenticationProvider());
    managerBuilder.authenticationProvider(customAuthenticationProvider2());

    http.authroizeHttpReqeusts(auth -> auth.anyRequest().authenticated());
    http.formLogin(Customizer.withDefaults());

    return http.build();
}

@Bean
public AuthenticationProvider customAuthenticationProvider() {
    return new CustomAuthenticationProvier();
}

@Bean
public AuthenticationProvider customAuthenticationProvider2() {
    return new CustomAuthenticationProvier2();
}
```
<div align="center">
<img src="https://github.com/user-attachments/assets/131c6dc1-ec03-4ea6-a672-2c0bf22ac90d">
</div>

-----
### ì½”ë“œ
-----
1. AuthenticationProvider
```java
package org.springframework.security.authentication;

import org.springframework.security.core.Authentication;
import org.springframework.security.core.AuthenticationException;

public interface AuthenticationProvider {
    Authentication authenticate(Authentication authentication) throws AuthenticationException;

    boolean supports(Class<?> authentication);
}
```

2. DaoAuthenticationProvider
```java
public DaoAuthenticationProvider() {
        this(PasswordEncoderFactories.createDelegatingPasswordEncoder());
}
```

3. InitializeUserDetailsBeanManagerConfigurer : ì„¤ì • í´ë˜ìŠ¤
```java
public void configure(AuthenticationManagerBuilder auth) throws Exception {
    String[] beanNames = InitializeUserDetailsBeanManagerConfigurer.this.context.getBeanNamesForType(UserDetailsService.class);
    if (auth.isConfigured()) {
        if (beanNames.length > 0) {
            this.logger.warn("Global AuthenticationManager configured with an AuthenticationProvider bean. UserDetailsService beans will not be used by Spring Security for automatically configuring username/password login. Consider removing the AuthenticationProvider bean. Alternatively, consider using the UserDetailsService in a manually instantiated DaoAuthenticationProvider. If the current configuration is intentional, to turn off this warning, increase the logging level of 'org.springframework.security.config.annotation.authentication.configuration.InitializeUserDetailsBeanManagerConfigurer' to ERROR");
        }

    } else if (beanNames.length != 0) {
        if (beanNames.length > 1) {
            this.logger.warn(LogMessage.format("Found %s UserDetailsService beans, with names %s. Global Authentication Manager will not use a UserDetailsService for username/password login. Consider publishing a single UserDetailsService bean.", beanNames.length, Arrays.toString(beanNames)));
        } else {
            // ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜´
            UserDetailsService userDetailsService = (UserDetailsService)InitializeUserDetailsBeanManagerConfigurer.this.context.getBean(beanNames[0], UserDetailsService.class);
            PasswordEncoder passwordEncoder = (PasswordEncoder)this.getBeanOrNull(PasswordEncoder.class);
            UserDetailsPasswordService passwordManager = (UserDetailsPasswordService)this.getBeanOrNull(UserDetailsPasswordService.class);
            CompromisedPasswordChecker passwordChecker = (CompromisedPasswordChecker)this.getBeanOrNull(CompromisedPasswordChecker.class);
            DaoAuthenticationProvider provider;
            if (passwordEncoder != null) {
                provider = new DaoAuthenticationProvider(passwordEncoder); // DaoAuthenticationProvider ìƒì„±
            } else {
                provider = new DaoAuthenticationProvider();
            }

            provider.setUserDetailsService(userDetailsService);
            if (passwordManager != null) {
                provider.setUserDetailsPasswordService(passwordManager);
            }

            if (passwordChecker != null) {
                provider.setCompromisedPasswordChecker(passwordChecker);
            }

            provider.afterPropertiesSet();
            auth.authenticationProvider(provider); // DaoAuthenticationProviderê°€ Defaultë¡œ ìƒì„±
            this.logger.info(LogMessage.format("Global AuthenticationManager configured with UserDetailsService bean with name %s", beanNames[0]));
        }
    }
}

private <T> T getBeanOrNull(Class<T> type) {
    return InitializeUserDetailsBeanManagerConfigurer.this.context.getBeanProvider(type).getIfUnique(); // AuthenticationProvider íƒ€ì…ì˜ ë¹ˆ í™•ì¸
}
```

4. InitializeAuthenticationProviderBeanManagerConfigurer : ì„¤ì • í´ë˜ìŠ¤
```java
package org.springframework.security.config.annotation.authentication.configuration;

import java.util.Arrays;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.springframework.context.ApplicationContext;
import org.springframework.core.annotation.Order;
import org.springframework.core.log.LogMessage;
import org.springframework.security.authentication.AuthenticationProvider;
import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;

@Order(2147478547)
class InitializeAuthenticationProviderBeanManagerConfigurer extends GlobalAuthenticationConfigurerAdapter {
    static final int DEFAULT_ORDER = 2147478547;
    private final ApplicationContext context;

    InitializeAuthenticationProviderBeanManagerConfigurer(ApplicationContext context) {
        this.context = context;
    }

    public void init(AuthenticationManagerBuilder auth) throws Exception {
        auth.apply(new InitializeAuthenticationProviderManagerConfigurer());
    }

    class InitializeAuthenticationProviderManagerConfigurer extends GlobalAuthenticationConfigurerAdapter {
        private final Log logger = LogFactory.getLog(this.getClass());

        InitializeAuthenticationProviderManagerConfigurer() {
        }

        public void configure(AuthenticationManagerBuilder auth) {
            if (!auth.isConfigured()) {
                String[] beanNames = InitializeAuthenticationProviderBeanManagerConfigurer.this.context.getBeanNamesForType(AuthenticationProvider.class);
                if (beanNames.length != 0) {
                    if (beanNames.length > 1) {
                        this.logger.info(LogMessage.format("Found %s AuthenticationProvider beans, with names %s. Global Authentication Manager will not be configured with AuthenticationProviders. Consider publishing a single AuthenticationProvider bean, or wiring your Providers directly using the DSL.", beanNames.length, Arrays.toString(beanNames)));
                    } else {
                        // Beanìœ¼ë¡œ ì •ì˜ëœ AuthenticationProviderë¥¼ ì°¾ìŒ
                        AuthenticationProvider authenticationProvider = (AuthenticationProvider)InitializeAuthenticationProviderBeanManagerConfigurer.this.context.getBean(beanNames[0], AuthenticationProvider.class);
                        auth.authenticationProvider(authenticationProvider); // ì—†ìœ¼ë©´, Defaultë¡œ AuthenticationProvider í•˜ë‚˜ ìƒì„± (DaoAuthenticationProvider)
                        this.logger.info(LogMessage.format("Global AuthenticationManager configured with AuthenticationProvider bean with name %s", beanNames[0]));
                    }
                }
            }
        }
    }
}
```

5. AuthenticationManagerBuilder
```java
public boolean isConfigured() {
    return !this.authenticationProviders.isEmpty() || this.parentAuthenticationManager != null;
}
```

6. CustomAuthenticationProviderë¥¼ ì¼ë°˜ ê°ì²´ë¡œ ìƒì„±í•˜ì—¬ ì¶”ê°€
  - CustomAuthenticationProvider
```java
package io.security.springsecuritymaster;

import org.springframework.security.authentication.AuthenticationProvider;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.AuthenticationException;
import org.springframework.security.core.authority.SimpleGrantedAuthority;

import java.util.List;

public class CustomAuthenticationProvider implements AuthenticationProvider {

    @Override
    public Authentication authenticate(Authentication authentication) throws AuthenticationException {
        String loginId = authentication.getName();
        String password = (String) authentication.getCredentials();

        // ì•„ì´ë”” ê²€ì¦

        // ë¹„ë°€ë²ˆí˜¸ ê²€ì¦

        // ê²€ì¦ ì™„ë£Œë˜ë©´ í† í° ìƒì„±
        return new UsernamePasswordAuthenticationToken(loginId, password, List.of(new SimpleGrantedAuthority("ROLE_USER")));
    }

    @Override
    public boolean supports(Class<?> authentication) {
        // Authentication ê°ì²´ì™€ ì¸ì¦ì„ ì²˜ë¦¬í•  í† í°ì˜ íƒ€ì…ì´ ê°™ì€ì§€ í™•ì¸
        return authentication.isAssignableFrom(UsernamePasswordAuthenticationToken.class);
    }
}
```

  - CustomAuthenticationProvider2
```java
package io.security.springsecuritymaster;

import org.springframework.security.authentication.AuthenticationProvider;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.AuthenticationException;
import org.springframework.security.core.authority.SimpleGrantedAuthority;

import java.util.List;

public class CustomAuthenticationProvider2 implements AuthenticationProvider {

    @Override
    public Authentication authenticate(Authentication authentication) throws AuthenticationException {
        String loginId = authentication.getName();
        String password = (String) authentication.getCredentials();

        // ì•„ì´ë”” ê²€ì¦
        // ë¹„ë°€ë²ˆí˜¸ ê²€ì¦

        // ê²€ì¦ ì™„ë£Œë˜ë©´ í† í° ìƒì„±
        return new UsernamePasswordAuthenticationToken(loginId, password, List.of(new SimpleGrantedAuthority("ROLE_USER")));
    }

    @Override
    public boolean supports(Class<?> authentication) {
        // Authentication ê°ì²´ì™€ ì¸ì¦ì„ ì²˜ë¦¬í•  í† í°ì˜ íƒ€ì…ì´ ê°™ì€ì§€ í™•ì¸
        return authentication.isAssignableFrom(UsernamePasswordAuthenticationToken.class);
    }
}
```

  - SecurityConfig
```java
@EnableWebSecurity
@Configuration
public class SecurityConfig {

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {

        // ë°©ì‹ 1
        AuthenticationManagerBuilder builder = http.getSharedObject(AuthenticationManagerBuilder.class);
        builder.authenticationProvider(new CustomAuthenticationProvider());
        builder.authenticationProvider(new CustomAuthenticationProvider2());

        http
                .authorizeHttpRequests(auth -> auth
                        .anyRequest().authenticated()) // ì–´ë– í•œ Requestì— ëŒ€í•´ì„œ ì¸ì¦ì„ ë°›ì•„ ì¸ê°€ ì‹¤ì‹œ
                .formLogin(Customizer.withDefaults());
        
                // ë°©ì‹ 2
                // .authenticationProvider(new CustomAuthenticationProvider())
                // .authenticationProvider(new CustomAuthenticationProvider2());
        
        return http.build();
    }

    @Bean
    public UserDetailsService userDetailsService() {
        UserDetails user = User.withUsername("user")
                .password("{noop}1111")
                .roles("USER")
                .build();

        return new InMemoryUserDetailsManager(user);
    }
}
```

7. CustomAuthenticationProviderë¥¼ í•˜ë‚˜ì˜ ë¹ˆìœ¼ë¡œ ì¶”ê°€
```java
@EnableWebSecurity
@Configuration
public class SecurityConfig {

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        
        http
                .authorizeHttpRequests(auth -> auth
                        .anyRequest().authenticated()) // ì–´ë– í•œ Requestì— ëŒ€í•´ì„œ ì¸ì¦ì„ ë°›ì•„ ì¸ê°€ ì‹¤ì‹œ
                .formLogin(Customizer.withDefaults());
        
                // ë°©ì‹ 2
                // .authenticationProvider(new CustomAuthenticationProvider())
                // .authenticationProvider(new CustomAuthenticationProvider2());
        
        return http.build();
    }

    @Bean
    public AuthenticationProvider authenticationProvider() {
        return new CustomAuthenticationProvider();
    }

    @Bean
    public UserDetailsService userDetailsService() {
        UserDetails user = User.withUsername("user")
                .password("{noop}1111")
                .roles("USER")
                .build();

        return new InMemoryUserDetailsManager(user);
    }
}
```

8. CustomAuthenticationProviderì— ë¹ˆ ë‘ê°œ ì´ìƒ ì¶”ê°€
```java
@EnableWebSecurity
@Configuration
public class SecurityConfig {

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http, AuthenticationManagerBuilder builder, AuthenticationConfiguration configuration) throws Exception {

        AuthenticationManagerBuilder managerBuilder = http.getSharedObject(AuthenticationManagerBuilder.class);
        managetBuilder.authenticationProvider(customAuthenticationProvider());

        AuthenticationManager authenticationManager = (ProviderManager) configuration.getAuthenticationManager();
        authenticationManager.getProviders().remove(0);

        builder.authenticationProvider(new DaoAuthenticationProvider());

        http
                .authorizeHttpRequests(auth -> auth
                        .anyRequest().authenticated()) // ì–´ë– í•œ Requestì— ëŒ€í•´ì„œ ì¸ì¦ì„ ë°›ì•„ ì¸ê°€ ì‹¤ì‹œ
                .formLogin(Customizer.withDefaults());
        
                // ë°©ì‹ 2
                // .authenticationProvider(new CustomAuthenticationProvider())
                // .authenticationProvider(new CustomAuthenticationProvider2());
        
        return http.build();
    }

    @Bean
    public AuthenticationProvider authenticationProvider() {
        return new CustomAuthenticationProvider();
    }

    @Bean
    public UserDetailsService userDetailsService() {
        UserDetails user = User.withUsername("user")
                .password("{noop}1111")
                .roles("USER")
                .build();

        return new InMemoryUserDetailsManager(user);
    }
}
```

```java
@EnableWebSecurity
@Configuration
public class SecurityConfig {

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http, AuthenticationManagerBuilder builder, AuthenticationConfiguration configuration) throws Exception {
        AuthenticationManagerBuilder managerBuilder = http.getSharedObject(AuthenticationManagerBuilder.class);
        managetBuilder.authenticationProvider(customAuthenticationProvider());
        managetBuilder.authenticationProvider(customAuthenticationProvider2());

        http
                .authorizeHttpRequests(auth -> auth
                        .anyRequest().authenticated()) // ì–´ë– í•œ Requestì— ëŒ€í•´ì„œ ì¸ì¦ì„ ë°›ì•„ ì¸ê°€ ì‹¤ì‹œ
                .formLogin(Customizer.withDefaults());
        
                // ë°©ì‹ 2
                // .authenticationProvider(new CustomAuthenticationProvider())
                // .authenticationProvider(new CustomAuthenticationProvider2());
        
        return http.build();
    }

    @Bean
    public AuthenticationProvider authenticationProvider() {
        return new CustomAuthenticationProvider();
    }

    @Bean
    public AuthenticationProvider authenticationProvider2() {
        return new CustomAuthenticationProvider2();
    }

    @Bean
    public UserDetailsService userDetailsService() {
        UserDetails user = User.withUsername("user")
                .password("{noop}1111")
                .roles("USER")
                .build();

        return new InMemoryUserDetailsManager(user);
    }
}
```
